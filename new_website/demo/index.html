<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Connect to a NormCode server to use the AI-powered demo client.">
    <meta name="theme-color" content="#4DA3FF">
    <link rel="icon" type="image/png" href="../assets/images/logo.png">
    <title>Demo — PsylensAI</title>

    <!-- Shared site fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Shared site CSS -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <!-- Gateway-specific CSS -->
    <link rel="stylesheet" href="css/gateway.css">
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>

    <main id="main">
        <div class="gateway-wrapper">
            <div class="gateway-card">
                <div class="gateway-icon">
                    <svg viewBox="0 0 24 24">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                    </svg>
                </div>

                <h1 data-i18n="gateway.title">Connect to NormCode Server</h1>
                <p class="gateway-subtext" data-i18n="gateway.subtitle">
                    Enter your server address and access token provided by your administrator.
                </p>

                <div class="gateway-form">
                    <div class="form-field">
                        <label for="gatewayServerUrl" data-i18n="gateway.labelUrl">Server Address</label>
                        <input type="text" id="gatewayServerUrl"
                               placeholder="http://your-server:8081"
                               autocomplete="url"
                               spellcheck="false">
                    </div>

                    <div class="form-field">
                        <label for="gatewayToken" data-i18n="gateway.labelToken">Access Token</label>
                        <div class="token-input-wrap">
                            <input type="password" id="gatewayToken"
                                   placeholder="nc_xxxxxxxxxxxxxxxx"
                                   autocomplete="off"
                                   spellcheck="false">
                            <button type="button" class="token-toggle" onclick="toggleTokenVisibility()" aria-label="Toggle visibility">
                                <svg id="eyeIcon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="gatewayWarning" class="gateway-warning" data-i18n="gateway.mixedContent">
                    This site uses HTTPS. Your server must also use HTTPS, or mixed content will be blocked by the browser.
                </div>

                <button id="gatewayConnectBtn" class="gateway-btn" onclick="gatewayConnect()">
                    <span class="spinner"></span>
                    <span class="btn-text" data-i18n="gateway.connect">Connect</span>
                </button>

                <div id="gatewayStatus" class="gateway-status"></div>

                <p class="gateway-hint" data-i18n="gateway.hint">
                    Don't have credentials? Contact your NormCode administrator.
                </p>
            </div>
        </div>
    </main>

    <!-- Shared navigation (i18n + nav) -->
    <script src="../js/i18n.js"></script>
    <script src="../js/nav.js"></script>

    <script>
        // ---- i18n translations ----
        i18n.init({
            en: {
                nav: {
                    brandText: 'Psylens.AI', home: 'Home', docs: 'Documentation',
                    overview: 'Overview', syntax: 'Syntax Reference', execution: 'Execution Model',
                    compilation: 'Compilation', examples: 'Examples', demo: 'Demo', about: 'About',
                    features: 'Features'
                },
                footer: {
                    tagline: 'Structured AI Planning That You Can Audit',
                    paper: 'Research Paper', contact: 'Contact',
                    office: 'TIMETABLE GBA Youth Innovation Base, Nansha, Guangzhou'
                },
                gateway: {
                    title: 'Connect to NormCode Server',
                    subtitle: 'Enter your server address and access token provided by your administrator.',
                    labelUrl: 'Server Address',
                    labelToken: 'Access Token',
                    connect: 'Connect',
                    hint: "Don't have credentials? Contact your NormCode administrator.",
                    mixedContent: 'This site uses HTTPS. Your server must also use HTTPS, or mixed content will be blocked by the browser.'
                }
            },
            zh: {
                nav: {
                    brandText: '心镜智', home: '首页', docs: '文档',
                    overview: '概述', syntax: '语法参考', execution: '执行模型',
                    compilation: '编译流程', examples: '示例', demo: '演示', about: '关于',
                    features: '功能'
                },
                footer: {
                    tagline: '可审计的结构化AI规划',
                    paper: '研究论文', contact: '联系我们',
                    office: '广州市南沙区黄阁镇海滨路创享湾4栋TIMETABLE粤港澳青创基地'
                },
                gateway: {
                    title: '连接 NormCode 服务器',
                    subtitle: '请输入管理员提供的服务器地址和访问令牌。',
                    labelUrl: '服务器地址',
                    labelToken: '访问令牌',
                    connect: '连接',
                    hint: '没有凭证？请联系您的 NormCode 管理员。',
                    mixedContent: '此站点使用 HTTPS。您的服务器也必须使用 HTTPS，否则浏览器将阻止混合内容请求。'
                }
            }
        });

        // ---- Gateway logic ----

        const SESSION_KEY_URL = 'normcode_server_url';
        const SESSION_KEY_TOKEN = 'normcode_access_token';

        // Bilingual runtime messages
        function getMsg(key) {
            const lang = i18n.getLang();
            const msgs = {
                en: {
                    errorEmptyUrl: 'Please enter a server address.',
                    errorEmptyToken: 'Please enter an access token.',
                    errorUnreachable: 'Server is unreachable. Please check the address and try again.',
                    errorMixed: 'HTTPS page cannot connect to HTTP server (mixed content restriction).',
                    errorInvalidToken: 'Invalid access token. Please check with your administrator.',
                    success: 'Authenticated. Redirecting...'
                },
                zh: {
                    errorEmptyUrl: '请输入服务器地址。',
                    errorEmptyToken: '请输入访问令牌。',
                    errorUnreachable: '服务器无法访问。请检查地址后重试。',
                    errorMixed: 'HTTPS 页面无法连接 HTTP 服务器（混合内容限制）。',
                    errorInvalidToken: '访问令牌无效，请联系管理员确认。',
                    success: '认证成功，正在跳转...'
                }
            };
            return (msgs[lang] || msgs.en)[key] || key;
        }

        // Toggle token field visibility
        function toggleTokenVisibility() {
            const input = document.getElementById('gatewayToken');
            const icon = document.getElementById('eyeIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
            }
        }

        // On load: pre-fill from sessionStorage, show HTTPS warning
        (function init() {
            const storedUrl = sessionStorage.getItem(SESSION_KEY_URL);
            const storedToken = sessionStorage.getItem(SESSION_KEY_TOKEN);
            if (storedUrl) document.getElementById('gatewayServerUrl').value = storedUrl;
            if (storedToken) document.getElementById('gatewayToken').value = storedToken;
            if (window.location.protocol === 'https:') {
                document.getElementById('gatewayWarning').style.display = 'block';
            }
        })();

        // Enter key support on both fields
        document.getElementById('gatewayServerUrl').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); document.getElementById('gatewayToken').focus(); }
        });
        document.getElementById('gatewayToken').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { e.preventDefault(); gatewayConnect(); }
        });

        async function gatewayConnect() {
            const urlInput = document.getElementById('gatewayServerUrl');
            const tokenInput = document.getElementById('gatewayToken');
            const btn = document.getElementById('gatewayConnectBtn');
            const status = document.getElementById('gatewayStatus');
            let url = urlInput.value.trim();
            const token = tokenInput.value.trim();

            // Clear previous state
            status.className = 'gateway-status';
            urlInput.classList.remove('input-error');
            tokenInput.classList.remove('input-error');

            // Validate server URL
            if (!url) {
                status.textContent = getMsg('errorEmptyUrl');
                status.className = 'gateway-status status-error';
                urlInput.classList.add('input-error');
                urlInput.focus();
                return;
            }

            // Validate token
            if (!token) {
                status.textContent = getMsg('errorEmptyToken');
                status.className = 'gateway-status status-error';
                tokenInput.classList.add('input-error');
                tokenInput.focus();
                return;
            }

            // Normalize: add http:// if no protocol
            if (!/^https?:\/\//i.test(url)) {
                url = 'http://' + url;
                urlInput.value = url;
            }

            // Remove trailing slash
            url = url.replace(/\/+$/, '');

            // Mixed content check
            if (window.location.protocol === 'https:' && url.startsWith('http://')) {
                status.textContent = getMsg('errorMixed');
                status.className = 'gateway-status status-error';
                urlInput.classList.add('input-error');
                return;
            }

            // Start loading
            btn.classList.add('loading');
            btn.disabled = true;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const resp = await fetch(url + '/health', { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!resp.ok) throw new Error('Health check failed');

                // Store credentials and redirect to plan selection
                sessionStorage.setItem(SESSION_KEY_URL, url);
                sessionStorage.setItem(SESSION_KEY_TOKEN, token);

                status.textContent = getMsg('success');
                status.className = 'gateway-status status-success';

                setTimeout(() => {
                    window.location.href = 'plans.html';
                }, 600);

            } catch (e) {
                status.textContent = getMsg('errorUnreachable');
                status.className = 'gateway-status status-error';
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
