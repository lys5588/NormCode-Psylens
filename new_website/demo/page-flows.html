<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NormCode Page-Flows Client ‚Äî Step-by-step guided workflow">
    <meta name="theme-color" content="#4DA3FF">
    <link rel="icon" type="image/png" href="../assets/images/logo.png">
    <title>Page-Flows ‚Äî PsylensAI</title>

    <!-- Shared site fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Shared site CSS -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        /* ---- Page-Flows layout ---- */
        .pf-wrapper {
            margin-top: var(--nav-height);
            min-height: calc(100vh - var(--nav-height));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            background: linear-gradient(135deg, var(--hero-gradient-start) 0%, var(--hero-gradient-mid) 45%, var(--hero-gradient-end) 100%);
        }

        /* Step dots */
        .pf-dots {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        .pf-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }
        .pf-dot.active { background: var(--accent); transform: scale(1.3); }
        .pf-dot.done { background: var(--success); }

        /* Card */
        .pf-card {
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            padding: var(--space-2xl) var(--space-xl);
            max-width: 560px;
            width: 100%;
            box-shadow: var(--shadow-md);
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        /* Steps ‚Äî only active is shown */
        .pf-step { display: none; flex-direction: column; flex: 1; }
        .pf-step.active { display: flex; }

        .pf-step-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }
        .pf-step-subtitle {
            font-size: var(--text-sm);
            color: var(--text-muted);
            margin-bottom: var(--space-lg);
        }

        /* Navigation */
        .pf-nav {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-lg);
            max-width: 560px;
            width: 100%;
        }
        .pf-btn {
            padding: 10px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .pf-btn-back {
            background: none;
            color: var(--text-muted);
        }
        .pf-btn-back:hover { color: var(--accent); }
        .pf-btn-back:disabled { opacity: 0; pointer-events: none; }
        .pf-btn-next {
            background: var(--accent);
            color: white;
        }
        .pf-btn-next:hover { background: var(--accent-hover); }
        .pf-btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Connection info */
        .pf-info-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 8px 12px;
            font-size: var(--text-sm);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--space-xs);
        }
        .pf-info-label { color: var(--text-muted); min-width: 50px; }
        .pf-info-value { flex: 1; font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pf-status-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
            background: var(--border);
        }
        .pf-status-dot.connected { background: var(--success); }
        .pf-status-dot.error { background: var(--error); }
        .pf-connect-msg {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--space-sm);
            text-align: center;
        }
        .pf-connect-msg.error { color: var(--error); }

        /* Form fields */
        .pf-field { margin-bottom: var(--space-md); }
        .pf-field label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }
        .pf-field input, .pf-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-family: var(--font-sans);
            color: var(--text-primary);
            background: var(--bg-white);
            box-sizing: border-box;
            transition: border-color var(--transition-fast);
        }
        .pf-field input:focus, .pf-field textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        .pf-required { color: var(--error); }

        /* File upload */
        .pf-ref-section { margin-bottom: var(--space-md); }
        .pf-ref-label {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }
        .pf-file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: var(--space-xs);
        }
        .pf-file-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 4px 8px;
            font-size: var(--text-xs);
            background: var(--bg-subtle);
            border-radius: var(--border-radius-sm);
        }
        .pf-file-item span { flex: 1; font-family: var(--font-mono); }
        .pf-file-actions {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
        }
        .pf-file-preview, .pf-file-remove {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: var(--text-xs); padding: 2px 4px;
        }
        .pf-file-preview:hover { color: var(--accent); }
        .pf-file-remove:hover { color: var(--error); }
        .pf-drop-area {
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            padding: 12px;
            text-align: center;
            font-size: var(--text-xs);
            color: var(--text-muted);
            cursor: pointer;
            transition: border-color var(--transition-fast);
        }
        .pf-drop-area:hover { border-color: var(--accent); }
        .pf-drop-area.dragover { border-color: var(--accent); background: var(--accent-soft); }

        /* Review */
        .pf-review-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: var(--text-sm);
        }
        .pf-review-item:last-child { border-bottom: none; }
        .pf-review-label { color: var(--text-muted); }
        .pf-review-value { color: var(--text-primary); font-weight: 500; text-align: right; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pf-launch-btn {
            width: 100%;
            padding: 14px;
            margin-top: var(--space-lg);
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-base);
            font-weight: 600;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .pf-launch-btn:hover { background: var(--accent-hover); }
        .pf-launch-btn:disabled { opacity: 0.6; cursor: wait; }

        /* Running */
        .pf-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-subtle);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-md) 0;
        }
        .pf-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .pf-run-status {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }
        .pf-run-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: var(--text-sm);
            gap: var(--space-sm);
        }

        /* Preview modal */
        .pf-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            padding: 24px;
        }
        .pf-modal-overlay.open { display: flex; }
        .pf-modal {
            background: var(--bg-white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg, 0 8px 32px rgba(0,0,0,0.25));
            width: 90vw;
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .pf-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .pf-modal-title {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            color: var(--text-primary);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .pf-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            line-height: 1;
        }
        .pf-modal-close:hover { color: var(--text-primary); background: var(--bg-subtle); }
        .pf-modal-body {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        .pf-modal-body pre {
            margin: 0;
            padding: 16px 20px;
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--text-primary);
        }
        .pf-modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Step timeline */
        .pf-timeline {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            margin-bottom: var(--space-sm);
        }
        .pf-timeline:empty::after {
            content: '';
            display: block;
            padding: 12px;
        }
        .pf-tl-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 6px 10px;
            font-size: var(--text-xs);
            border-bottom: 1px solid var(--border);
        }
        .pf-tl-item:last-child { border-bottom: none; }
        .pf-tl-icon {
            width: 18px;
            text-align: center;
            flex-shrink: 0;
        }
        .pf-tl-name {
            flex: 1;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .pf-tl-meta {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 11px;
            flex-shrink: 0;
        }
        .pf-tl-item.running .pf-tl-icon { color: var(--accent); }
        .pf-tl-item.done .pf-tl-icon { color: var(--success); }
        .pf-tl-item.failed .pf-tl-icon { color: var(--error); }
        .pf-tl-item.skipped .pf-tl-icon { color: var(--text-muted); }

        @keyframes pf-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .pf-tl-item.running .pf-tl-icon {
            animation: pf-pulse 1.2s ease-in-out infinite;
        }

        /* Output files in step 4 */
        .pf-files-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        .pf-files-toggle .pf-toggle-arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }
        .pf-files-toggle.open .pf-toggle-arrow { transform: rotate(90deg); }
        .pf-files-body {
            display: none;
            max-height: 160px;
            overflow-y: auto;
        }
        .pf-files-toggle.open + .pf-files-body { display: block; }
        .pf-file-card {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 5px 8px;
            font-size: var(--text-xs);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            margin-bottom: 4px;
        }
        .pf-file-card.final {
            border-color: var(--success);
            background: rgba(23, 191, 99, 0.04);
        }
        .pf-fc-icon { flex-shrink: 0; }
        .pf-fc-name {
            flex: 1;
            font-family: var(--font-mono);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }
        .pf-fc-size {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 10px;
            flex-shrink: 0;
        }
        .pf-fc-actions {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
        }
        .pf-fc-btn {
            background: none;
            border: none;
            font-size: var(--text-xs);
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 4px;
        }
        .pf-fc-btn:hover { color: var(--accent); }

        .pf-section-label {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 2px;
            margin-top: var(--space-xs);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .pf-wrapper { padding: var(--space-md); }
            .pf-card { padding: var(--space-xl) var(--space-lg); min-height: 280px; }
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>

    <main id="main">
        <div class="pf-wrapper">
            <!-- Step dots -->
            <div class="pf-dots">
                <div class="pf-dot active" onclick="goTo(0)"></div>
                <div class="pf-dot" onclick="goTo(1)"></div>
                <div class="pf-dot" onclick="goTo(2)"></div>
                <div class="pf-dot" onclick="goTo(3)"></div>
                <div class="pf-dot" onclick="goTo(4)"></div>
            </div>

            <!-- Card -->
            <div class="pf-card">
                <!-- Step 0: Connection -->
                <div class="pf-step active" data-step="0">
                    <div class="pf-step-title" data-i18n="pf.s0title">Connection</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s0sub">Verifying server and loading configuration...</div>
                    <div style="flex:1">
                        <div class="pf-info-row">
                            <span class="pf-status-dot" id="pfConnDot"></span>
                            <span class="pf-info-label" data-i18n="pf.labelServer">Server</span>
                            <span class="pf-info-value" id="pfServer">‚Äî</span>
                        </div>
                        <div class="pf-info-row">
                            <span class="pf-info-label" data-i18n="pf.labelPlan">Plan</span>
                            <span class="pf-info-value" id="pfPlan">‚Äî</span>
                        </div>
                        <div class="pf-info-row">
                            <span class="pf-info-label" data-i18n="pf.labelModel">Model</span>
                            <span class="pf-info-value" id="pfModel">‚Äî</span>
                        </div>
                        <div class="pf-connect-msg" id="pfConnMsg" data-i18n="pf.connecting">Connecting...</div>
                    </div>
                </div>

                <!-- Step 1: Basic Inputs -->
                <div class="pf-step" data-step="1">
                    <div class="pf-step-title" data-i18n="pf.s1title">Basic Inputs</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s1sub">What should this presentation be about?</div>
                    <div style="flex:1">
                        <div class="pf-field">
                            <label data-i18n-html="pf.labelTopic">Topic <span class="pf-required">*</span></label>
                            <input type="text" id="pfTopic" value="">
                        </div>
                        <div class="pf-field">
                            <label data-i18n="pf.labelAudience">Audience</label>
                            <input type="text" id="pfAudience" value="">
                        </div>
                        <div class="pf-field">
                            <label data-i18n="pf.labelLength">Length</label>
                            <input type="text" id="pfLength" value="">
                        </div>
                    </div>
                </div>

                <!-- Step 2: References -->
                <div class="pf-step" data-step="2">
                    <div class="pf-step-title" data-i18n="pf.s2title">References</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s2sub">Add content, templates, or style guides (optional).</div>
                    <div style="flex:1;overflow-y:auto">
                        <!-- Content refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label" data-i18n="pf.refContent">Content Files</div>
                            <div class="pf-file-list" id="pfContentList"></div>
                            <div class="pf-drop-area" id="pfContentDrop"
                                 onclick="document.getElementById('pfContentInput').click()"
                                 ondrop="pfDrop(event,'content')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                <span data-i18n="pf.dropContent">+ Add .md, .txt, .json</span>
                                <input type="file" id="pfContentInput" multiple hidden onchange="pfFiles(event,'content')">
                            </div>
                        </div>
                        <!-- Template refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label" data-i18n="pf.refTemplate">HTML Templates</div>
                            <div class="pf-file-list" id="pfTemplateList"></div>
                            <div class="pf-drop-area" id="pfTemplateDrop"
                                 onclick="document.getElementById('pfTemplateInput').click()"
                                 ondrop="pfDrop(event,'template')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                <span data-i18n="pf.dropTemplate">+ Add .html</span>
                                <input type="file" id="pfTemplateInput" multiple hidden onchange="pfFiles(event,'template')">
                            </div>
                        </div>
                        <!-- Style refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label" data-i18n="pf.refStyle">Style Guides</div>
                            <div class="pf-file-list" id="pfStyleList"></div>
                            <div class="pf-drop-area" id="pfStyleDrop"
                                 onclick="document.getElementById('pfStyleInput').click()"
                                 ondrop="pfDrop(event,'style')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                <span data-i18n="pf.dropStyle">+ Add .css, .md, .txt</span>
                                <input type="file" id="pfStyleInput" multiple hidden onchange="pfFiles(event,'style')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review & Launch -->
                <div class="pf-step" data-step="3">
                    <div class="pf-step-title" data-i18n="pf.s3title">Review & Launch</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s3sub">Confirm your settings and start generation.</div>
                    <div style="flex:1">
                        <div id="pfReviewContent"></div>
                        <button class="pf-launch-btn" id="pfLaunchBtn" onclick="launchRun()" data-i18n="pf.launch">Launch</button>
                    </div>
                </div>

                <!-- Step 4: Running -->
                <div class="pf-step" data-step="4">
                    <div class="pf-step-title" data-i18n="pf.s4title">Running</div>
                    <div class="pf-step-subtitle" id="pfRunSub" data-i18n="pf.runSub">Generating your presentation...</div>
                    <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
                        <div class="pf-progress-bar">
                            <div class="pf-progress-fill" id="pfProgressFill"></div>
                        </div>
                        <div class="pf-run-status" id="pfRunStatus" data-i18n="pf.runWaiting">Waiting...</div>

                        <!-- Step timeline -->
                        <div class="pf-section-label" data-i18n="pf.timelineTitle">Steps</div>
                        <div class="pf-timeline" id="pfTimeline"></div>

                        <!-- Files produced -->
                        <div class="pf-files-toggle" id="pfFilesToggle" onclick="this.classList.toggle('open')">
                            <span data-i18n="pf.filesTitle">Files</span>
                            <span class="pf-toggle-arrow">&#9654;</span>
                        </div>
                        <div class="pf-files-body" id="pfFilesBody">
                            <div id="pfFinalFiles"></div>
                            <div id="pfIntermediateFiles"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="pf-nav">
                <button class="pf-btn pf-btn-back" id="pfBtnBack" onclick="prevStep()" disabled data-i18n-html="pf.back">&larr; Back</button>
                <button class="pf-btn pf-btn-next" id="pfBtnNext" onclick="nextStep()" disabled data-i18n-html="pf.next">Next &rarr;</button>
            </div>
        </div>
    </main>

    <!-- Preview modal -->
    <div class="pf-modal-overlay" id="pfPreviewOverlay" onclick="closePreview(event)">
        <div class="pf-modal" onclick="event.stopPropagation()">
            <div class="pf-modal-header">
                <span class="pf-modal-title" id="pfPreviewTitle"></span>
                <button class="pf-modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="pf-modal-body" id="pfPreviewBody"></div>
        </div>
    </div>

    <!-- Shared navigation (i18n + nav) -->
    <script src="../js/i18n.js"></script>
    <script src="../js/nav.js"></script>

    <script>
        // ---- i18n ----
        i18n.init({
            en: {
                nav: { brandText: 'Psylens.AI', home: 'Home', docs: 'Documentation', overview: 'Overview', syntax: 'Syntax Reference', execution: 'Execution Model', compilation: 'Compilation', examples: 'Examples', demo: 'Demo', about: 'About', features: 'Features' },
                footer: { tagline: 'Structured AI Planning That You Can Audit', paper: 'Research Paper', contact: 'Contact', office: 'TIMETABLE GBA Youth Innovation Base, Nansha, Guangzhou' },
                pf: {
                    s0title: 'Connection', s0sub: 'Verifying server and loading configuration...',
                    s1title: 'Basic Inputs', s1sub: 'What should this presentation be about?',
                    s2title: 'References', s2sub: 'Add content, templates, or style guides (optional).',
                    s3title: 'Review & Launch', s3sub: 'Confirm your settings and start generation.',
                    s4title: 'Running',
                    labelServer: 'Server', labelPlan: 'Plan', labelModel: 'Model',
                    connecting: 'Connecting...', connected: 'Connected successfully', connFailed: 'Connection failed: ',
                    labelTopic: 'Topic <span class="pf-required">*</span>', labelAudience: 'Audience', labelLength: 'Length',
                    phTopic: 'e.g. Machine Learning Basics', phAudience: 'e.g. Technical beginners', phLength: 'e.g. 6 slides including title and Q&A',
                    refContent: 'Content Files', refTemplate: 'HTML Templates', refStyle: 'Style Guides',
                    dropContent: '+ Add .md, .txt, .json', dropTemplate: '+ Add .html', dropStyle: '+ Add .css, .md, .txt',
                    reviewTopic: 'Topic', reviewAudience: 'Audience', reviewLength: 'Length',
                    reviewContent: 'Content refs', reviewTemplate: 'Templates', reviewStyle: 'Style guides', reviewModel: 'Model',
                    nFiles: ' file(s)',
                    launch: 'Launch', uploading: 'Uploading files...', starting: 'Starting run...',
                    launchFailed: 'Launch failed: ',
                    runSub: 'Generating your presentation...', runWaiting: 'Waiting...', runPlaceholder: 'Event monitor coming soon',
                    runStarted: 'Run started: ', runCompleted: 'Completed!', runCompletedSub: 'Generation finished successfully.',
                    runFailed: 'Failed: ', inferences: ' inferences',
                    preview: 'Preview', previewFailed: 'Preview failed: ',
                    timelineTitle: 'Steps', filesTitle: 'Files',
                    finalOutputs: 'Final Outputs', intermediateFiles: 'Intermediate',
                    noFiles: 'Files will appear here...', download: 'Download',
                    loopIter: 'iter', seconds: 's',
                    back: '\u2190 Back', next: 'Next \u2192'
                }
            },
            zh: {
                nav: { brandText: 'ÂøÉÈïúÊô∫', home: 'È¶ñÈ°µ', docs: 'ÊñáÊ°£', overview: 'Ê¶ÇËø∞', syntax: 'ËØ≠Ê≥ïÂèÇËÄÉ', execution: 'ÊâßË°åÊ®°Âûã', compilation: 'ÁºñËØëÊµÅÁ®ã', examples: 'Á§∫‰æã', demo: 'ÊºîÁ§∫', about: 'ÂÖ≥‰∫é', features: 'ÂäüËÉΩ' },
                footer: { tagline: 'ÂèØÂÆ°ËÆ°ÁöÑÁªìÊûÑÂåñAIËßÑÂàí', paper: 'Á†îÁ©∂ËÆ∫Êñá', contact: 'ËÅîÁ≥ªÊàë‰ª¨', office: 'ÂπøÂ∑ûÂ∏ÇÂçóÊ≤ôÂå∫ÈªÑÈòÅÈïáÊµ∑Êª®Ë∑ØÂàõ‰∫´Êπæ4Ê†ãTIMETABLEÁ≤§Ê∏ØÊæ≥ÈùíÂàõÂü∫Âú∞' },
                pf: {
                    s0title: 'ËøûÊé•', s0sub: 'Ê≠£Âú®È™åËØÅÊúçÂä°Âô®Âπ∂Âä†ËΩΩÈÖçÁΩÆ...',
                    s1title: 'Âü∫Êú¨ËæìÂÖ•', s1sub: 'Ëøô‰∏™ÊºîÁ§∫ÊñáÁ®øÂ∫îËØ•ÂÖ≥‰∫é‰ªÄ‰πàÔºü',
                    s2title: 'ÂèÇËÄÉÊñá‰ª∂', s2sub: 'Ê∑ªÂä†ÂÜÖÂÆπ„ÄÅÊ®°ÊùøÊàñÊ†∑ÂºèÊåáÂçóÔºàÂèØÈÄâÔºâ„ÄÇ',
                    s3title: 'Á°ÆËÆ§Âπ∂ÂêØÂä®', s3sub: 'Á°ÆËÆ§ËÆæÁΩÆÂπ∂ÂºÄÂßãÁîüÊàê„ÄÇ',
                    s4title: 'ËøêË°å‰∏≠',
                    labelServer: 'ÊúçÂä°Âô®', labelPlan: 'ËÆ°Âàí', labelModel: 'Ê®°Âûã',
                    connecting: 'Ê≠£Âú®ËøûÊé•...', connected: 'ËøûÊé•ÊàêÂäü', connFailed: 'ËøûÊé•Â§±Ë¥•Ôºö',
                    labelTopic: '‰∏ªÈ¢ò <span class="pf-required">*</span>', labelAudience: 'ÁõÆÊ†áÂèó‰ºó', labelLength: 'ÊúüÊúõÈïøÂ∫¶',
                    phTopic: '‰æãÂ¶ÇÔºöÊú∫Âô®Â≠¶‰π†Âü∫Á°Ä', phAudience: '‰æãÂ¶ÇÔºöÊäÄÊúØÂàùÂ≠¶ËÄÖ', phLength: '‰æãÂ¶ÇÔºö6Âº†ÂπªÁÅØÁâáÔºàÂê´Ê†áÈ¢òÂíåÈóÆÁ≠îÔºâ',
                    refContent: 'ÂÜÖÂÆπÊñá‰ª∂', refTemplate: 'HTML Ê®°Êùø', refStyle: 'Ê†∑ÂºèÊåáÂçó',
                    dropContent: '+ Ê∑ªÂä† .md, .txt, .json', dropTemplate: '+ Ê∑ªÂä† .html', dropStyle: '+ Ê∑ªÂä† .css, .md, .txt',
                    reviewTopic: '‰∏ªÈ¢ò', reviewAudience: 'Âèó‰ºó', reviewLength: 'ÈïøÂ∫¶',
                    reviewContent: 'ÂÜÖÂÆπÂºïÁî®', reviewTemplate: 'Ê®°Êùø', reviewStyle: 'Ê†∑ÂºèÊåáÂçó', reviewModel: 'Ê®°Âûã',
                    nFiles: ' ‰∏™Êñá‰ª∂',
                    launch: 'ÂêØÂä®ÁîüÊàê', uploading: 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...', starting: 'Ê≠£Âú®ÂêØÂä®ËøêË°å...',
                    launchFailed: 'ÂêØÂä®Â§±Ë¥•Ôºö',
                    runSub: 'Ê≠£Âú®ÁîüÊàêÊºîÁ§∫ÊñáÁ®ø...', runWaiting: 'Á≠âÂæÖ‰∏≠...', runPlaceholder: '‰∫ã‰ª∂ÁõëËßÜÂô®Âç≥Â∞Ü‰∏äÁ∫ø',
                    runStarted: 'ËøêË°åÂ∑≤ÂêØÂä®Ôºö', runCompleted: 'Â∑≤ÂÆåÊàêÔºÅ', runCompletedSub: 'ÁîüÊàêÂ∑≤ÊàêÂäüÂÆåÊàê„ÄÇ',
                    runFailed: 'Â§±Ë¥•Ôºö', inferences: ' Ê¨°Êé®ÁêÜ',
                    preview: 'È¢ÑËßà', previewFailed: 'È¢ÑËßàÂ§±Ë¥•Ôºö',
                    timelineTitle: 'Ê≠•È™§', filesTitle: 'Êñá‰ª∂',
                    finalOutputs: 'ÊúÄÁªàËæìÂá∫', intermediateFiles: '‰∏≠Èó¥Êñá‰ª∂',
                    noFiles: 'Êñá‰ª∂Â∞ÜÂú®Ê≠§ÊòæÁ§∫...', download: '‰∏ãËΩΩ',
                    loopIter: 'ËΩÆ', seconds: 'Áßí',
                    back: '\u2190 ËøîÂõû', next: '‰∏ã‰∏ÄÊ≠• \u2192'
                }
            }
        });

        // ---- Runtime translation helper ----
        function t(key) {
            const lang = i18n.getLang();
            const en = { phTopic: 'e.g. Machine Learning Basics', phAudience: 'e.g. Technical beginners', phLength: 'e.g. 6 slides including title and Q&A', connecting: 'Connecting...', connected: 'Connected successfully', connFailed: 'Connection failed: ', reviewTopic: 'Topic', reviewAudience: 'Audience', reviewLength: 'Length', reviewContent: 'Content refs', reviewTemplate: 'Templates', reviewStyle: 'Style guides', reviewModel: 'Model', nFiles: ' file(s)', launch: 'Launch', uploading: 'Uploading files...', starting: 'Starting run...', launchFailed: 'Launch failed: ', runStarted: 'Run started: ', runCompleted: 'Completed!', runCompletedSub: 'Generation finished successfully.', runFailed: 'Failed: ', inferences: ' inferences', preview: 'Preview', previewFailed: 'Preview failed: ', timelineTitle: 'Steps', filesTitle: 'Files', finalOutputs: 'Final Outputs', intermediateFiles: 'Intermediate', noFiles: 'Files will appear here...', download: 'Download', loopIter: 'iter', seconds: 's' };
            const zh = { phTopic: '‰æãÂ¶ÇÔºöÊú∫Âô®Â≠¶‰π†Âü∫Á°Ä', phAudience: '‰æãÂ¶ÇÔºöÊäÄÊúØÂàùÂ≠¶ËÄÖ', phLength: '‰æãÂ¶ÇÔºö6Âº†ÂπªÁÅØÁâáÔºàÂê´Ê†áÈ¢òÂíåÈóÆÁ≠îÔºâ', connecting: 'Ê≠£Âú®ËøûÊé•...', connected: 'ËøûÊé•ÊàêÂäü', connFailed: 'ËøûÊé•Â§±Ë¥•Ôºö', reviewTopic: '‰∏ªÈ¢ò', reviewAudience: 'Âèó‰ºó', reviewLength: 'ÈïøÂ∫¶', reviewContent: 'ÂÜÖÂÆπÂºïÁî®', reviewTemplate: 'Ê®°Êùø', reviewStyle: 'Ê†∑ÂºèÊåáÂçó', reviewModel: 'Ê®°Âûã', nFiles: ' ‰∏™Êñá‰ª∂', launch: 'ÂêØÂä®ÁîüÊàê', uploading: 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...', starting: 'Ê≠£Âú®ÂêØÂä®ËøêË°å...', launchFailed: 'ÂêØÂä®Â§±Ë¥•Ôºö', runStarted: 'ËøêË°åÂ∑≤ÂêØÂä®Ôºö', runCompleted: 'Â∑≤ÂÆåÊàêÔºÅ', runCompletedSub: 'ÁîüÊàêÂ∑≤ÊàêÂäüÂÆåÊàê„ÄÇ', runFailed: 'Â§±Ë¥•Ôºö', inferences: ' Ê¨°Êé®ÁêÜ', preview: 'È¢ÑËßà', previewFailed: 'È¢ÑËßàÂ§±Ë¥•Ôºö', timelineTitle: 'Ê≠•È™§', filesTitle: 'Êñá‰ª∂', finalOutputs: 'ÊúÄÁªàËæìÂá∫', intermediateFiles: '‰∏≠Èó¥Êñá‰ª∂', noFiles: 'Êñá‰ª∂Â∞ÜÂú®Ê≠§ÊòæÁ§∫...', download: '‰∏ãËΩΩ', loopIter: 'ËΩÆ', seconds: 'Áßí' };
            return (lang === 'zh' ? zh : en)[key] || en[key] || key;
        }

        function applyPlaceholders() {
            document.getElementById('pfTopic').placeholder = t('phTopic');
            document.getElementById('pfAudience').placeholder = t('phAudience');
            document.getElementById('pfLength').placeholder = t('phLength');
        }
        applyPlaceholders();

        // Re-apply on language switch
        const _origSetLang = window.setLanguage;
        window.setLanguage = function(lang) {
            _origSetLang(lang);
            applyPlaceholders();
        };

        // ---- Session guards ----
        const serverUrl = sessionStorage.getItem('normcode_server_url');
        if (!serverUrl) { window.location.replace('index.html'); }
        else if (!sessionStorage.getItem('normcode_plan_id') && !sessionStorage.getItem('normcode_plans')) { window.location.replace('plans.html'); }

        // ---- State ----
        let step = 0;
        let connected = false;
        let selectedModel = '';
        let currentPlanId = sessionStorage.getItem('normcode_plan_id') || '';
        let pfContent = [];   // { name, path, content, isDefault }
        let pfTemplate = [];
        let pfStyle = [];

        const dots = document.querySelectorAll('.pf-dot');
        const steps = document.querySelectorAll('.pf-step');
        const btnBack = document.getElementById('pfBtnBack');
        const btnNext = document.getElementById('pfBtnNext');

        // ---- Navigation ----
        function goTo(n) {
            // Can't skip ahead of current furthest step unless connected
            if (n > 0 && !connected) return;
            if (n === 4 && step !== 3) return; // step 4 only via launch

            step = n;
            steps.forEach(s => s.classList.remove('active'));
            steps[step].classList.add('active');

            dots.forEach((d, i) => {
                d.classList.remove('active');
                d.classList.toggle('done', i < step);
            });
            dots[step].classList.add('active');

            btnBack.disabled = false;
            btnNext.style.display = step >= 3 ? 'none' : '';
            btnNext.disabled = step === 0 && !connected;

            if (step === 3) buildReview();
        }

        function nextStep() {
            if (step === 1) {
                const topic = document.getElementById('pfTopic').value.trim();
                if (!topic) { document.getElementById('pfTopic').focus(); return; }
            }
            if (step < 4) goTo(step + 1);
        }

        function prevStep() {
            if (step === 0) { window.location.href = 'plans.html'; return; }
            if (step > 0) goTo(step - 1);
        }

        // ---- Step 0: Connect ----
        async function connectToServer() {
            const connDot = document.getElementById('pfConnDot');
            const connMsg = document.getElementById('pfConnMsg');
            const serverDisplay = serverUrl.replace(/^https?:\/\//, '');
            document.getElementById('pfServer').textContent = serverDisplay;

            // Show plan name
            const plans = JSON.parse(sessionStorage.getItem('normcode_plans') || '[]');
            const plan = plans.find(p => p.id === currentPlanId);
            document.getElementById('pfPlan').textContent = plan ? (plan.name || plan.id) : currentPlanId || '‚Äî';

            connMsg.textContent = t('connecting');
            connMsg.className = 'pf-connect-msg';

            try {
                const health = await fetch(`${serverUrl}/health`);
                if (!health.ok) throw new Error('Server not responding');

                // Fetch models
                try {
                    const modelsResp = await fetch(`${serverUrl}/api/models`);
                    const models = await modelsResp.json();
                    const preferred = models.find(m => m.id === 'qwen-plus');
                    const nonDemo = models.find(m => !(m.name || m.id).toLowerCase().includes('demo'));
                    const selected = preferred || nonDemo || models[0];
                    if (selected) {
                        selectedModel = selected.id;
                        document.getElementById('pfModel').textContent = selected.name || selected.id;
                    }
                } catch (e) {
                    document.getElementById('pfModel').textContent = 'demo';
                    selectedModel = 'demo';
                }

                // Load plan defaults
                await loadDefaults();

                connDot.className = 'pf-status-dot connected';
                connMsg.textContent = t('connected');
                connected = true;
                btnNext.disabled = false;

            } catch (e) {
                connDot.className = 'pf-status-dot error';
                connMsg.textContent = t('connFailed') + e.message;
                connMsg.className = 'pf-connect-msg error';
            }
        }

        async function loadDefaults() {
            if (!currentPlanId) return;
            try {
                const resp = await fetch(`${serverUrl}/api/plans/${currentPlanId}/files/inputs.json`);
                if (!resp.ok) return;
                const fileResponse = await resp.json();
                const defaults = JSON.parse(fileResponse.content);

                if (defaults['{ÊºîÁ§∫‰∏ªÈ¢ò}']?.data?.[0]?.[0])
                    document.getElementById('pfTopic').value = defaults['{ÊºîÁ§∫‰∏ªÈ¢ò}'].data[0][0];
                if (defaults['{ÁõÆÊ†áÂèó‰ºó}']?.data?.[0]?.[0])
                    document.getElementById('pfAudience').value = defaults['{ÁõÆÊ†áÂèó‰ºó}'].data[0][0];
                if (defaults['{ÊúüÊúõÈïøÂ∫¶}']?.data?.[0]?.[0])
                    document.getElementById('pfLength').value = defaults['{ÊúüÊúõÈïøÂ∫¶}'].data[0][0];

                // Load default content refs
                if (defaults['[ÂÜÖÂÆπÂèÇËÄÉÂÖÉÊï∞ÊçÆ]']?.data?.[0]) {
                    defaults['[ÂÜÖÂÆπÂèÇËÄÉÂÖÉÊï∞ÊçÆ]'].data[0].forEach(ref => {
                        pfContent.push({ name: ref.name, path: ref.path, type: ref.type, isDefault: true });
                    });
                    renderFileList('content');
                }
                // Load default style refs
                if (defaults['[Ê†∑ÂºèÂèÇËÄÉÂÖÉÊï∞ÊçÆ]']?.data?.[0]) {
                    defaults['[Ê†∑ÂºèÂèÇËÄÉÂÖÉÊï∞ÊçÆ]'].data[0].forEach(ref => {
                        const isTemplate = ref.type === 'html_template';
                        (isTemplate ? pfTemplate : pfStyle).push({ name: ref.name, path: ref.path, type: ref.type, isDefault: true });
                    });
                    renderFileList('template');
                    renderFileList('style');
                }
            } catch (e) {
                console.warn('[loadDefaults]', e);
            }
        }

        // ---- Step 2: File uploads ----
        function getFileArray(category) {
            if (category === 'content') return pfContent;
            if (category === 'template') return pfTemplate;
            return pfStyle;
        }

        function renderFileList(category) {
            const arr = getFileArray(category);
            const listId = category === 'content' ? 'pfContentList' : category === 'template' ? 'pfTemplateList' : 'pfStyleList';
            const el = document.getElementById(listId);
            if (arr.length === 0) { el.innerHTML = ''; return; }
            el.innerHTML = arr.map((f, i) => `
                <div class="pf-file-item">
                    <span>${f.isDefault ? 'üìå ' : ''}${f.name}</span>
                    <div class="pf-file-actions">
                        <button class="pf-file-preview" onclick="previewFile('${category}',${i})" title="${t('preview')}">&#128065;</button>
                        <button class="pf-file-remove" onclick="removeFile('${category}',${i})">&times;</button>
                    </div>
                </div>
            `).join('');
        }

        function removeFile(category, idx) {
            getFileArray(category).splice(idx, 1);
            renderFileList(category);
        }

        function pfFiles(event, category) {
            const files = event.target.files;
            if (!files) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const catPath = category === 'template' ? 'templates' : category;
                    getFileArray(category).push({
                        name: file.name,
                        path: `provisions/inputs/${catPath}/${file.name}`,
                        content: e.target.result,
                        isDefault: false
                    });
                    renderFileList(category);
                };
                reader.readAsText(file);
            });
            event.target.value = '';
        }

        function pfDrop(event, category) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (!files) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const catPath = category === 'template' ? 'templates' : category;
                    getFileArray(category).push({
                        name: file.name,
                        path: `provisions/inputs/${catPath}/${file.name}`,
                        content: e.target.result,
                        isDefault: false
                    });
                    renderFileList(category);
                };
                reader.readAsText(file);
            });
        }

        function pfDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function pfDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        // ---- File preview (in-page modal) ----
        async function previewFile(category, idx) {
            const file = getFileArray(category)[idx];
            if (!file) return;

            const isHtml = /\.html?$/i.test(file.name);
            let content = file.content;

            // For default/server files without local content, fetch from server
            if (!content && file.path) {
                try {
                    const resp = await fetch(`${serverUrl}/api/plans/${currentPlanId}/files/${file.path}`);
                    if (!resp.ok) throw new Error(resp.statusText);
                    const data = await resp.json();
                    content = data.content;
                } catch (e) {
                    alert(t('previewFailed') + e.message);
                    return;
                }
            }

            if (!content) return;

            const overlay = document.getElementById('pfPreviewOverlay');
            const body = document.getElementById('pfPreviewBody');
            document.getElementById('pfPreviewTitle').textContent = file.name;

            if (isHtml) {
                const iframe = document.createElement('iframe');
                iframe.sandbox = 'allow-same-origin';
                body.innerHTML = '';
                body.appendChild(iframe);
                iframe.contentDocument.open();
                iframe.contentDocument.write(content);
                iframe.contentDocument.close();
            } else {
                body.innerHTML = '';
                const pre = document.createElement('pre');
                pre.textContent = content;
                body.appendChild(pre);
            }

            overlay.classList.add('open');
        }

        function closePreview(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('pfPreviewOverlay');
            overlay.classList.remove('open');
            document.getElementById('pfPreviewBody').innerHTML = '';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePreview();
        });

        // ---- Step 3: Review ----
        function buildReview() {
            const topic = document.getElementById('pfTopic').value.trim() || '‚Äî';
            const audience = document.getElementById('pfAudience').value.trim() || '‚Äî';
            const length = document.getElementById('pfLength').value.trim() || '‚Äî';
            const cCount = pfContent.length;
            const tCount = pfTemplate.length;
            const sCount = pfStyle.length;

            document.getElementById('pfReviewContent').innerHTML = `
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewTopic')}</span><span class="pf-review-value">${escapeHtml(topic)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewAudience')}</span><span class="pf-review-value">${escapeHtml(audience)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewLength')}</span><span class="pf-review-value">${escapeHtml(length)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewContent')}</span><span class="pf-review-value">${cCount}${t('nFiles')}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewTemplate')}</span><span class="pf-review-value">${tCount}${t('nFiles')}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewStyle')}</span><span class="pf-review-value">${sCount}${t('nFiles')}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">${t('reviewModel')}</span><span class="pf-review-value">${escapeHtml(selectedModel)}</span></div>
            `;
        }

        // ---- Step 3 ‚Üí 4: Launch ----
        async function launchRun() {
            const topic = document.getElementById('pfTopic').value.trim();
            const audience = document.getElementById('pfAudience').value.trim();
            const length = document.getElementById('pfLength').value.trim();
            const userId = `gui_${Date.now()}`;
            const launchBtn = document.getElementById('pfLaunchBtn');

            launchBtn.disabled = true;
            launchBtn.textContent = t('uploading');

            try {
                // Upload user files
                const uploadFile = (f, category) => {
                    return fetch(`${serverUrl}/api/userbenches/${userId}/files/${f.path}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                        body: f.content
                    });
                };

                const uploads = [];
                [...pfContent, ...pfTemplate, ...pfStyle].forEach(f => {
                    if (!f.isDefault && f.content) uploads.push(uploadFile(f));
                });
                await Promise.all(uploads);

                // Build refs
                const contentRefs = pfContent.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'content' }));
                const templateRefs = pfTemplate.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'html_template' }));
                const styleRefs = pfStyle.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'guide' }));
                const allStyleRefs = [...templateRefs, ...styleRefs];

                const payload = {
                    plan_id: currentPlanId,
                    llm_model: selectedModel,
                    user_id: userId,
                    ground_inputs: {
                        '{ÊºîÁ§∫‰∏ªÈ¢ò}': { data: [[topic]], axes: ['_none_axis'] },
                        '{ÁõÆÊ†áÂèó‰ºó}': { data: [[audience || '‰∏ÄËà¨Âèó‰ºó']], axes: ['_none_axis'] },
                        '{ÊúüÊúõÈïøÂ∫¶}': { data: [[length || '6Âº†ÂπªÁÅØÁâá']], axes: ['_none_axis'] },
                    }
                };
                if (contentRefs.length > 0) payload.ground_inputs['[ÂÜÖÂÆπÂèÇËÄÉÂÖÉÊï∞ÊçÆ]'] = { data: [contentRefs], axes: ['ÂÜÖÂÆπÂèÇËÄÉ'] };
                if (allStyleRefs.length > 0) payload.ground_inputs['[Ê†∑ÂºèÂèÇËÄÉÂÖÉÊï∞ÊçÆ]'] = { data: [allStyleRefs], axes: ['Ê†∑ÂºèÂèÇËÄÉ'] };

                launchBtn.textContent = t('starting');

                const resp = await fetch(`${serverUrl}/api/runs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || t('launchFailed'));
                }

                const data = await resp.json();
                const runId = data.run_id;

                // Move to step 4
                goTo(4);
                currentRunId = runId;
                currentUserId = userId;
                document.getElementById('pfRunStatus').textContent = t('runStarted') + `${runId.substring(0, 8)}...`;
                document.getElementById('pfProgressFill').style.width = '10%';
                document.getElementById('pfTimeline').innerHTML = '';
                document.getElementById('pfFinalFiles').innerHTML = '';
                document.getElementById('pfIntermediateFiles').innerHTML = '';

                startPfEventStream(runId, userId);

            } catch (e) {
                alert(t('launchFailed') + e.message);
                launchBtn.disabled = false;
                launchBtn.textContent = t('launch');
            }
        }

        // ---- Run tracking state ----
        let currentRunId = null;
        let currentUserId = null;
        let pfEvtSource = null;
        const pfLoop = { current: null, iteration: 0, completed: 0, total: 0 };
        // Map flow_index ‚Üí timeline DOM element for live updates
        const pfTimelineMap = {};

        // ---- SSE event stream ----
        function startPfEventStream(runId, userId) {
            if (pfEvtSource) pfEvtSource.close();
            pfEvtSource = new EventSource(`${serverUrl}/api/runs/${runId}/stream`);

            const eventTypes = [
                'inference:started', 'inference:completed', 'inference:failed',
                'inference:pending', 'inference:restarted', 'inference:skipped',
                'inference:in_progress', 'inference:retry', 'inference:error',
                'execution:progress', 'execution:paused',
                'file:changed', 'loop:progress',
                'run:completed', 'run:failed', 'run:started'
            ];

            eventTypes.forEach(type => {
                pfEvtSource.addEventListener(type, (e) => {
                    try { pfHandleEvent(type, JSON.parse(e.data)); } catch (err) {}
                });
            });

            pfEvtSource.onerror = () => {
                pfEvtSource.close();
                setTimeout(() => pfPollStatus(runId), 2000);
            };
        }

        function pfHandleEvent(type, data) {
            if (type === 'inference:started') {
                const name = (data.concept_name || data.flow_index || '‚Ä¶').substring(0, 40);
                const idx = data.flow_index || name;
                const isLoop = (data.sequence_type || '').toLowerCase().includes('loop') ||
                               (data.sequence_type || '').toLowerCase().includes('iterate');
                if (isLoop) {
                    pfLoop.current = idx;
                    pfLoop.iteration = 1;
                }
                addTimelineItem(idx, name, 'running', isLoop ? `${t('loopIter')} 1` : '');
            }
            else if (type === 'inference:completed') {
                const idx = data.flow_index || '';
                const dur = (data.duration || 0).toFixed(1) + t('seconds');
                if (data.is_loop && pfLoop.current === idx) {
                    const totalIter = data.total_iterations || pfLoop.iteration || 1;
                    updateTimelineItem(idx, 'done', `${totalIter} ${t('loopIter')} ¬∑ ${dur}`);
                    pfLoop.current = null;
                    pfLoop.iteration = 0;
                } else {
                    updateTimelineItem(idx, 'done', dur);
                }
                pfPollOutputFiles();
            }
            else if (type === 'inference:failed') {
                const idx = data.flow_index || '';
                updateTimelineItem(idx, 'failed', data.error || data.status || '');
            }
            else if (type === 'inference:skipped') {
                const idx = data.flow_index || '';
                if (!pfTimelineMap[idx]) addTimelineItem(idx, idx, 'skipped', '');
                else updateTimelineItem(idx, 'skipped', '');
            }
            else if (type === 'inference:pending' || type === 'inference:restarted' || type === 'loop:progress') {
                const idx = data.flow_index || '';
                const iter = data.iteration || (pfLoop.iteration + 1);
                pfLoop.current = idx;
                pfLoop.iteration = iter;
                updateTimelineMeta(idx, `${t('loopIter')} ${iter}`);
            }
            else if (type === 'inference:in_progress' || type === 'inference:retry') {
                const idx = data.flow_index || '';
                if (!pfTimelineMap[idx]) addTimelineItem(idx, idx, 'running', '');
            }
            else if (type === 'inference:error') {
                const idx = data.flow_index || '';
                updateTimelineItem(idx, 'failed', data.error || '');
            }
            else if (type === 'execution:progress') {
                pfLoop.completed = data.completed_count || data.completed || 0;
                pfLoop.total = data.total_count || data.total || 0;
                pfUpdateProgress(pfLoop.completed, pfLoop.total);
            }
            else if (type === 'file:changed') {
                pfPollOutputFiles();
            }
            else if (type === 'run:completed') {
                if (pfEvtSource) pfEvtSource.close();
                document.getElementById('pfProgressFill').style.width = '100%';
                document.getElementById('pfRunStatus').textContent = t('runCompleted');
                document.getElementById('pfRunSub').textContent = t('runCompletedSub');
                pfPollOutputFiles();
                // Auto-expand files section
                const toggle = document.getElementById('pfFilesToggle');
                if (!toggle.classList.contains('open')) toggle.classList.add('open');
            }
            else if (type === 'run:failed') {
                if (pfEvtSource) pfEvtSource.close();
                document.getElementById('pfRunStatus').textContent = t('runFailed') + (data.error || 'Unknown');
                document.getElementById('pfProgressFill').style.width = '0%';
            }
        }

        // ---- Progress bar ----
        function pfUpdateProgress(completed, total) {
            const pct = total > 0 ? Math.min(Math.round(completed / total * 100), 100) : 0;
            document.getElementById('pfProgressFill').style.width = pct + '%';
            let text = `${completed} / ${total}${t('inferences')}`;
            if (pfLoop.current && pfLoop.iteration > 0) {
                text += ` ¬∑ ${t('loopIter')} ${pfLoop.iteration}`;
            }
            document.getElementById('pfRunStatus').textContent = text;
        }

        // ---- Timeline helpers ----
        function addTimelineItem(id, name, status, meta) {
            const timeline = document.getElementById('pfTimeline');
            const icons = { running: '&#9654;', done: '&#10003;', failed: '&#10007;', skipped: '&#8709;' };
            const div = document.createElement('div');
            div.className = `pf-tl-item ${status}`;
            div.dataset.id = id;
            div.innerHTML = `
                <span class="pf-tl-icon">${icons[status] || '&#9654;'}</span>
                <span class="pf-tl-name">${escapeHtml(name)}</span>
                <span class="pf-tl-meta">${escapeHtml(meta)}</span>
            `;
            timeline.appendChild(div);
            timeline.scrollTop = timeline.scrollHeight;
            pfTimelineMap[id] = div;
        }

        function updateTimelineItem(id, status, meta) {
            const div = pfTimelineMap[id];
            if (!div) return;
            const icons = { running: '&#9654;', done: '&#10003;', failed: '&#10007;', skipped: '&#8709;' };
            div.className = `pf-tl-item ${status}`;
            div.querySelector('.pf-tl-icon').innerHTML = icons[status] || '';
            if (meta !== undefined) div.querySelector('.pf-tl-meta').textContent = meta;
        }

        function updateTimelineMeta(id, meta) {
            const div = pfTimelineMap[id];
            if (!div) return;
            div.querySelector('.pf-tl-meta').textContent = meta;
        }

        // ---- File polling ----
        let pfPollTimer = null;
        async function pfPollOutputFiles() {
            if (!currentUserId) return;
            // Debounce rapid calls
            clearTimeout(pfPollTimer);
            pfPollTimer = setTimeout(async () => {
                try {
                    const resp = await fetch(`${serverUrl}/api/userbenches/${currentUserId}/files?category=productions&recursive=true`);
                    if (!resp.ok) return;
                    const files = await resp.json();
                    pfRenderFiles(files);
                } catch (e) {}
            }, 500);
        }

        function pfRenderFiles(files) {
            const allFiles = files.filter(f => !f.is_dir);
            const finals = allFiles.filter(f => f.path.includes('output/'));
            const intermediates = allFiles.filter(f => !f.path.includes('output/'));

            const extIcons = { html: '&#127760;', pptx: '&#128202;', json: '&#128203;', pdf: '&#128196;', md: '&#128221;', css: '&#127912;', txt: '&#128196;' };
            function icon(name) {
                const ext = name.split('.').pop().toLowerCase();
                return extIcons[ext] || '&#128196;';
            }
            function size(bytes) {
                return bytes > 1024 ? (bytes / 1024).toFixed(1) + ' KB' : bytes + ' B';
            }

            const finalEl = document.getElementById('pfFinalFiles');
            const interEl = document.getElementById('pfIntermediateFiles');

            if (finals.length > 0) {
                finalEl.innerHTML = `<div class="pf-section-label">${t('finalOutputs')}</div>` +
                    finals.map(f => `
                        <div class="pf-file-card final">
                            <span class="pf-fc-icon">${icon(f.name)}</span>
                            <span class="pf-fc-name">${escapeHtml(f.name)}</span>
                            <span class="pf-fc-size">${size(f.size || 0)}</span>
                            <div class="pf-fc-actions">
                                <button class="pf-fc-btn" onclick="pfPreviewOutput('${f.path}','${escapeHtml(f.name)}')" title="${t('preview')}">&#128065;</button>
                                <button class="pf-fc-btn" onclick="pfDownload('${f.path}','${escapeHtml(f.name)}')" title="${t('download')}">&#11015;</button>
                            </div>
                        </div>
                    `).join('');
            } else {
                finalEl.innerHTML = '';
            }

            if (intermediates.length > 0) {
                interEl.innerHTML = `<div class="pf-section-label">${t('intermediateFiles')}</div>` +
                    intermediates.map(f => `
                        <div class="pf-file-card">
                            <span class="pf-fc-icon">${icon(f.name)}</span>
                            <span class="pf-fc-name">${escapeHtml(f.name)}</span>
                            <span class="pf-fc-size">${size(f.size || 0)}</span>
                            <div class="pf-fc-actions">
                                <button class="pf-fc-btn" onclick="pfPreviewOutput('${f.path}','${escapeHtml(f.name)}')" title="${t('preview')}">&#128065;</button>
                            </div>
                        </div>
                    `).join('');
            } else {
                interEl.innerHTML = '';
            }

            // Auto-expand when first file arrives
            if (allFiles.length > 0) {
                const toggle = document.getElementById('pfFilesToggle');
                if (!toggle.classList.contains('open')) toggle.classList.add('open');
            }
        }

        // ---- Preview / Download output files (reuses existing modal) ----
        async function pfPreviewOutput(path, name) {
            const isHtml = /\.html?$/i.test(name);
            try {
                const resp = await fetch(`${serverUrl}/api/userbenches/${currentUserId}/files/${path}`);
                if (!resp.ok) throw new Error(resp.statusText);

                let content;
                const ct = resp.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    const data = await resp.json();
                    content = typeof data.content === 'string' ? data.content : JSON.stringify(data, null, 2);
                } else {
                    content = await resp.text();
                }

                const overlay = document.getElementById('pfPreviewOverlay');
                const body = document.getElementById('pfPreviewBody');
                document.getElementById('pfPreviewTitle').textContent = name;

                if (isHtml) {
                    const iframe = document.createElement('iframe');
                    iframe.sandbox = 'allow-same-origin';
                    body.innerHTML = '';
                    body.appendChild(iframe);
                    iframe.contentDocument.open();
                    iframe.contentDocument.write(content);
                    iframe.contentDocument.close();
                } else {
                    body.innerHTML = '';
                    const pre = document.createElement('pre');
                    pre.textContent = content;
                    body.appendChild(pre);
                }
                overlay.classList.add('open');
            } catch (e) {
                alert(t('previewFailed') + e.message);
            }
        }

        function pfDownload(path, name) {
            const a = document.createElement('a');
            a.href = `${serverUrl}/api/userbenches/${currentUserId}/files/${path}`;
            a.download = name;
            a.click();
        }

        // ---- Fallback: poll run status if SSE drops ----
        async function pfPollStatus(runId) {
            if (!runId) return;
            try {
                const resp = await fetch(`${serverUrl}/api/runs/${runId}`);
                const data = await resp.json();
                if (data.progress) {
                    pfUpdateProgress(data.progress.completed_count || 0, data.progress.total_count || 0);
                }
                if (data.status === 'completed') {
                    pfHandleEvent('run:completed', {});
                } else if (data.status === 'failed') {
                    pfHandleEvent('run:failed', { error: data.error });
                } else if (data.status === 'running') {
                    setTimeout(() => pfPollStatus(runId), 3000);
                }
            } catch (e) {
                setTimeout(() => pfPollStatus(runId), 5000);
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ---- Init ----
        goTo(0);
        connectToServer();
    </script>
</body>
</html>
