<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NormCode Page-Flows Client â€” Step-by-step guided workflow">
    <meta name="theme-color" content="#4DA3FF">
    <link rel="icon" type="image/png" href="../assets/images/logo.png">
    <title>Page-Flows â€” PsylensAI</title>

    <!-- Shared site fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Shared site CSS -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        /* ---- Page-Flows layout ---- */
        .pf-wrapper {
            margin-top: var(--nav-height);
            min-height: calc(100vh - var(--nav-height));
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            background: linear-gradient(135deg, var(--hero-gradient-start) 0%, var(--hero-gradient-mid) 45%, var(--hero-gradient-end) 100%);
        }

        /* Step dots */
        .pf-dots {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
        }
        .pf-dot {
            width: 10px; height: 10px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s;
            cursor: pointer;
        }
        .pf-dot.active { background: var(--accent); transform: scale(1.3); }
        .pf-dot.done { background: var(--success); }

        /* Card */
        .pf-card {
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-lg);
            padding: var(--space-2xl) var(--space-xl);
            max-width: 560px;
            width: 100%;
            box-shadow: var(--shadow-md);
            min-height: 320px;
            display: flex;
            flex-direction: column;
        }

        /* Steps â€” only active is shown */
        .pf-step { display: none; flex-direction: column; flex: 1; }
        .pf-step.active { display: flex; }

        .pf-step-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }
        .pf-step-subtitle {
            font-size: var(--text-sm);
            color: var(--text-muted);
            margin-bottom: var(--space-lg);
        }

        /* Navigation */
        .pf-nav {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-lg);
            max-width: 560px;
            width: 100%;
        }
        .pf-btn {
            padding: 10px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-weight: 500;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .pf-btn-back {
            background: none;
            color: var(--text-muted);
        }
        .pf-btn-back:hover { color: var(--accent); }
        .pf-btn-back:disabled { opacity: 0; pointer-events: none; }
        .pf-btn-next {
            background: var(--accent);
            color: white;
        }
        .pf-btn-next:hover { background: var(--accent-hover); }
        .pf-btn-next:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Connection info */
        .pf-info-row {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 8px 12px;
            font-size: var(--text-sm);
            border: 1px solid var(--border);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--space-xs);
        }
        .pf-info-label { color: var(--text-muted); min-width: 50px; }
        .pf-info-value { flex: 1; font-family: var(--font-mono); font-size: var(--text-xs); color: var(--text-primary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pf-status-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
            background: var(--border);
        }
        .pf-status-dot.connected { background: var(--success); }
        .pf-status-dot.error { background: var(--error); }
        .pf-connect-msg {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--space-sm);
            text-align: center;
        }
        .pf-connect-msg.error { color: var(--error); }

        /* Form fields */
        .pf-field { margin-bottom: var(--space-md); }
        .pf-field label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }
        .pf-field input, .pf-field textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--border-radius);
            font-size: var(--text-sm);
            font-family: var(--font-sans);
            color: var(--text-primary);
            background: var(--bg-white);
            box-sizing: border-box;
            transition: border-color var(--transition-fast);
        }
        .pf-field input:focus, .pf-field textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        .pf-required { color: var(--error); }

        /* File upload */
        .pf-ref-section { margin-bottom: var(--space-md); }
        .pf-ref-label {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }
        .pf-file-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: var(--space-xs);
        }
        .pf-file-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 4px 8px;
            font-size: var(--text-xs);
            background: var(--bg-subtle);
            border-radius: var(--border-radius-sm);
        }
        .pf-file-item span { flex: 1; font-family: var(--font-mono); }
        .pf-file-remove {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: var(--text-xs); padding: 2px 4px;
        }
        .pf-file-remove:hover { color: var(--error); }
        .pf-drop-area {
            border: 2px dashed var(--border);
            border-radius: var(--border-radius);
            padding: 12px;
            text-align: center;
            font-size: var(--text-xs);
            color: var(--text-muted);
            cursor: pointer;
            transition: border-color var(--transition-fast);
        }
        .pf-drop-area:hover { border-color: var(--accent); }
        .pf-drop-area.dragover { border-color: var(--accent); background: var(--accent-soft); }

        /* Review */
        .pf-review-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: var(--text-sm);
        }
        .pf-review-item:last-child { border-bottom: none; }
        .pf-review-label { color: var(--text-muted); }
        .pf-review-value { color: var(--text-primary); font-weight: 500; text-align: right; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pf-launch-btn {
            width: 100%;
            padding: 14px;
            margin-top: var(--space-lg);
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--text-base);
            font-weight: 600;
            font-family: var(--font-sans);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .pf-launch-btn:hover { background: var(--accent-hover); }
        .pf-launch-btn:disabled { opacity: 0.6; cursor: wait; }

        /* Running */
        .pf-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-subtle);
            border-radius: 4px;
            overflow: hidden;
            margin: var(--space-md) 0;
        }
        .pf-progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .pf-run-status {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }
        .pf-run-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: var(--text-sm);
            gap: var(--space-sm);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .pf-wrapper { padding: var(--space-md); }
            .pf-card { padding: var(--space-xl) var(--space-lg); min-height: 280px; }
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Skip to content</a>

    <main id="main">
        <div class="pf-wrapper">
            <!-- Step dots -->
            <div class="pf-dots">
                <div class="pf-dot active" onclick="goTo(0)"></div>
                <div class="pf-dot" onclick="goTo(1)"></div>
                <div class="pf-dot" onclick="goTo(2)"></div>
                <div class="pf-dot" onclick="goTo(3)"></div>
                <div class="pf-dot" onclick="goTo(4)"></div>
            </div>

            <!-- Card -->
            <div class="pf-card">
                <!-- Step 0: Connection -->
                <div class="pf-step active" data-step="0">
                    <div class="pf-step-title" data-i18n="pf.s0title">Connection</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s0sub">Verifying server and loading configuration...</div>
                    <div style="flex:1">
                        <div class="pf-info-row">
                            <span class="pf-status-dot" id="pfConnDot"></span>
                            <span class="pf-info-label">Server</span>
                            <span class="pf-info-value" id="pfServer">â€”</span>
                        </div>
                        <div class="pf-info-row">
                            <span class="pf-info-label">Plan</span>
                            <span class="pf-info-value" id="pfPlan">â€”</span>
                        </div>
                        <div class="pf-info-row">
                            <span class="pf-info-label">Model</span>
                            <span class="pf-info-value" id="pfModel">â€”</span>
                        </div>
                        <div class="pf-connect-msg" id="pfConnMsg">Connecting...</div>
                    </div>
                </div>

                <!-- Step 1: Basic Inputs -->
                <div class="pf-step" data-step="1">
                    <div class="pf-step-title" data-i18n="pf.s1title">Basic Inputs</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s1sub">What should this presentation be about?</div>
                    <div style="flex:1">
                        <div class="pf-field">
                            <label>Topic <span class="pf-required">*</span></label>
                            <input type="text" id="pfTopic" value="" placeholder="e.g. Machine Learning Basics">
                        </div>
                        <div class="pf-field">
                            <label>Audience</label>
                            <input type="text" id="pfAudience" value="" placeholder="e.g. Technical beginners">
                        </div>
                        <div class="pf-field">
                            <label>Length</label>
                            <input type="text" id="pfLength" value="" placeholder="e.g. 6 slides including title and Q&A">
                        </div>
                    </div>
                </div>

                <!-- Step 2: References -->
                <div class="pf-step" data-step="2">
                    <div class="pf-step-title" data-i18n="pf.s2title">References</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s2sub">Add content, templates, or style guides (optional).</div>
                    <div style="flex:1;overflow-y:auto">
                        <!-- Content refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label">Content Files</div>
                            <div class="pf-file-list" id="pfContentList"></div>
                            <div class="pf-drop-area" id="pfContentDrop"
                                 onclick="document.getElementById('pfContentInput').click()"
                                 ondrop="pfDrop(event,'content')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                + Add .md, .txt, .json
                                <input type="file" id="pfContentInput" multiple hidden onchange="pfFiles(event,'content')">
                            </div>
                        </div>
                        <!-- Template refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label">HTML Templates</div>
                            <div class="pf-file-list" id="pfTemplateList"></div>
                            <div class="pf-drop-area" id="pfTemplateDrop"
                                 onclick="document.getElementById('pfTemplateInput').click()"
                                 ondrop="pfDrop(event,'template')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                + Add .html
                                <input type="file" id="pfTemplateInput" multiple hidden onchange="pfFiles(event,'template')">
                            </div>
                        </div>
                        <!-- Style refs -->
                        <div class="pf-ref-section">
                            <div class="pf-ref-label">Style Guides</div>
                            <div class="pf-file-list" id="pfStyleList"></div>
                            <div class="pf-drop-area" id="pfStyleDrop"
                                 onclick="document.getElementById('pfStyleInput').click()"
                                 ondrop="pfDrop(event,'style')" ondragover="pfDragOver(event)" ondragleave="pfDragLeave(event)">
                                + Add .css, .md, .txt
                                <input type="file" id="pfStyleInput" multiple hidden onchange="pfFiles(event,'style')">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review & Launch -->
                <div class="pf-step" data-step="3">
                    <div class="pf-step-title" data-i18n="pf.s3title">Review & Launch</div>
                    <div class="pf-step-subtitle" data-i18n="pf.s3sub">Confirm your settings and start generation.</div>
                    <div style="flex:1">
                        <div id="pfReviewContent"></div>
                        <button class="pf-launch-btn" id="pfLaunchBtn" onclick="launchRun()">Launch</button>
                    </div>
                </div>

                <!-- Step 4: Running -->
                <div class="pf-step" data-step="4">
                    <div class="pf-step-title" data-i18n="pf.s4title">Running</div>
                    <div class="pf-step-subtitle" id="pfRunSub">Generating your presentation...</div>
                    <div style="flex:1;display:flex;flex-direction:column">
                        <div class="pf-progress-bar">
                            <div class="pf-progress-fill" id="pfProgressFill"></div>
                        </div>
                        <div class="pf-run-status" id="pfRunStatus">Waiting...</div>
                        <div class="pf-run-placeholder" id="pfRunPlaceholder">
                            <div>Event monitor coming soon</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="pf-nav">
                <button class="pf-btn pf-btn-back" id="pfBtnBack" onclick="prevStep()" disabled>&larr; Back</button>
                <button class="pf-btn pf-btn-next" id="pfBtnNext" onclick="nextStep()" disabled>Next &rarr;</button>
            </div>
        </div>
    </main>

    <!-- Shared navigation (i18n + nav) -->
    <script src="../js/i18n.js"></script>
    <script src="../js/nav.js"></script>

    <script>
        // ---- i18n ----
        i18n.init({
            en: {
                nav: { brandText: 'Psylens.AI', home: 'Home', docs: 'Documentation', overview: 'Overview', syntax: 'Syntax Reference', execution: 'Execution Model', compilation: 'Compilation', examples: 'Examples', demo: 'Demo', about: 'About', features: 'Features' },
                footer: { tagline: 'Structured AI Planning That You Can Audit', paper: 'Research Paper', contact: 'Contact', office: 'TIMETABLE GBA Youth Innovation Base, Nansha, Guangzhou' },
                pf: {
                    s0title: 'Connection', s0sub: 'Verifying server and loading configuration...',
                    s1title: 'Basic Inputs', s1sub: 'What should this presentation be about?',
                    s2title: 'References', s2sub: 'Add content, templates, or style guides (optional).',
                    s3title: 'Review & Launch', s3sub: 'Confirm your settings and start generation.',
                    s4title: 'Running'
                }
            },
            zh: {
                nav: { brandText: '\u5fc3\u955c\u667a', home: '\u9996\u9875', docs: '\u6587\u6863', overview: '\u6982\u8ff0', syntax: '\u8bed\u6cd5\u53c2\u8003', execution: '\u6267\u884c\u6a21\u578b', compilation: '\u7f16\u8bd1\u6d41\u7a0b', examples: '\u793a\u4f8b', demo: '\u6f14\u793a', about: '\u5173\u4e8e', features: '\u529f\u80fd' },
                footer: { tagline: '\u53ef\u5ba1\u8ba1\u7684\u7ed3\u6784\u5316AI\u89c4\u5212', paper: '\u7814\u7a76\u8bba\u6587', contact: '\u8054\u7cfb\u6211\u4eec', office: '\u5e7f\u5dde\u5e02\u5357\u6c99\u533a\u9ec4\u9601\u9547\u6d77\u6ee8\u8def\u521b\u4eab\u6e7e4\u680bTIMETABLE\u7ca4\u6e2f\u6fb3\u9752\u521b\u57fa\u5730' },
                pf: {
                    s0title: '\u8fde\u63a5', s0sub: '\u6b63\u5728\u9a8c\u8bc1\u670d\u52a1\u5668\u5e76\u52a0\u8f7d\u914d\u7f6e...',
                    s1title: '\u57fa\u672c\u8f93\u5165', s1sub: '\u8fd9\u4e2a\u6f14\u793a\u6587\u7a3f\u5e94\u8be5\u5173\u4e8e\u4ec0\u4e48\uff1f',
                    s2title: '\u53c2\u8003\u6587\u4ef6', s2sub: '\u6dfb\u52a0\u5185\u5bb9\u3001\u6a21\u677f\u6216\u6837\u5f0f\u6307\u5357\uff08\u53ef\u9009\uff09\u3002',
                    s3title: '\u786e\u8ba4\u5e76\u542f\u52a8', s3sub: '\u786e\u8ba4\u8bbe\u7f6e\u5e76\u5f00\u59cb\u751f\u6210\u3002',
                    s4title: '\u8fd0\u884c\u4e2d'
                }
            }
        });

        // ---- Session guards ----
        const serverUrl = sessionStorage.getItem('normcode_server_url');
        if (!serverUrl) { window.location.replace('index.html'); }
        else if (!sessionStorage.getItem('normcode_plan_id') && !sessionStorage.getItem('normcode_plans')) { window.location.replace('plans.html'); }

        // ---- State ----
        let step = 0;
        let connected = false;
        let selectedModel = '';
        let currentPlanId = sessionStorage.getItem('normcode_plan_id') || '';
        let pfContent = [];   // { name, path, content, isDefault }
        let pfTemplate = [];
        let pfStyle = [];

        const dots = document.querySelectorAll('.pf-dot');
        const steps = document.querySelectorAll('.pf-step');
        const btnBack = document.getElementById('pfBtnBack');
        const btnNext = document.getElementById('pfBtnNext');

        // ---- Navigation ----
        function goTo(n) {
            // Can't skip ahead of current furthest step unless connected
            if (n > 0 && !connected) return;
            if (n === 4 && step !== 3) return; // step 4 only via launch

            step = n;
            steps.forEach(s => s.classList.remove('active'));
            steps[step].classList.add('active');

            dots.forEach((d, i) => {
                d.classList.remove('active');
                d.classList.toggle('done', i < step);
            });
            dots[step].classList.add('active');

            btnBack.disabled = step === 0;
            btnNext.style.display = step >= 3 ? 'none' : '';
            btnNext.disabled = step === 0 && !connected;

            if (step === 3) buildReview();
        }

        function nextStep() {
            if (step === 1) {
                const topic = document.getElementById('pfTopic').value.trim();
                if (!topic) { document.getElementById('pfTopic').focus(); return; }
            }
            if (step < 4) goTo(step + 1);
        }

        function prevStep() {
            if (step > 0) goTo(step - 1);
        }

        // ---- Step 0: Connect ----
        async function connectToServer() {
            const connDot = document.getElementById('pfConnDot');
            const connMsg = document.getElementById('pfConnMsg');
            const serverDisplay = serverUrl.replace(/^https?:\/\//, '');
            document.getElementById('pfServer').textContent = serverDisplay;

            // Show plan name
            const plans = JSON.parse(sessionStorage.getItem('normcode_plans') || '[]');
            const plan = plans.find(p => p.id === currentPlanId);
            document.getElementById('pfPlan').textContent = plan ? (plan.name || plan.id) : currentPlanId || 'â€”';

            connMsg.textContent = 'Connecting...';
            connMsg.className = 'pf-connect-msg';

            try {
                const health = await fetch(`${serverUrl}/health`);
                if (!health.ok) throw new Error('Server not responding');

                // Fetch models
                try {
                    const modelsResp = await fetch(`${serverUrl}/api/models`);
                    const models = await modelsResp.json();
                    const preferred = models.find(m => m.id === 'qwen-plus');
                    const nonDemo = models.find(m => !(m.name || m.id).toLowerCase().includes('demo'));
                    const selected = preferred || nonDemo || models[0];
                    if (selected) {
                        selectedModel = selected.id;
                        document.getElementById('pfModel').textContent = selected.name || selected.id;
                    }
                } catch (e) {
                    document.getElementById('pfModel').textContent = 'demo';
                    selectedModel = 'demo';
                }

                // Load plan defaults
                await loadDefaults();

                connDot.className = 'pf-status-dot connected';
                connMsg.textContent = 'Connected successfully';
                connected = true;
                btnNext.disabled = false;

            } catch (e) {
                connDot.className = 'pf-status-dot error';
                connMsg.textContent = 'Connection failed: ' + e.message;
                connMsg.className = 'pf-connect-msg error';
            }
        }

        async function loadDefaults() {
            if (!currentPlanId) return;
            try {
                const resp = await fetch(`${serverUrl}/api/plans/${currentPlanId}/files/inputs.json`);
                if (!resp.ok) return;
                const fileResponse = await resp.json();
                const defaults = JSON.parse(fileResponse.content);

                if (defaults['{æ¼”ç¤ºä¸»é¢˜}']?.data?.[0]?.[0])
                    document.getElementById('pfTopic').value = defaults['{æ¼”ç¤ºä¸»é¢˜}'].data[0][0];
                if (defaults['{ç›®æ ‡å—ä¼—}']?.data?.[0]?.[0])
                    document.getElementById('pfAudience').value = defaults['{ç›®æ ‡å—ä¼—}'].data[0][0];
                if (defaults['{æœŸæœ›é•¿åº¦}']?.data?.[0]?.[0])
                    document.getElementById('pfLength').value = defaults['{æœŸæœ›é•¿åº¦}'].data[0][0];

                // Load default content refs
                if (defaults['[å†…å®¹å‚è€ƒå…ƒæ•°æ®]']?.data?.[0]) {
                    defaults['[å†…å®¹å‚è€ƒå…ƒæ•°æ®]'].data[0].forEach(ref => {
                        pfContent.push({ name: ref.name, path: ref.path, type: ref.type, isDefault: true });
                    });
                    renderFileList('content');
                }
                // Load default style refs
                if (defaults['[æ ·å¼å‚è€ƒå…ƒæ•°æ®]']?.data?.[0]) {
                    defaults['[æ ·å¼å‚è€ƒå…ƒæ•°æ®]'].data[0].forEach(ref => {
                        const isTemplate = ref.type === 'html_template';
                        (isTemplate ? pfTemplate : pfStyle).push({ name: ref.name, path: ref.path, type: ref.type, isDefault: true });
                    });
                    renderFileList('template');
                    renderFileList('style');
                }
            } catch (e) {
                console.warn('[loadDefaults]', e);
            }
        }

        // ---- Step 2: File uploads ----
        function getFileArray(category) {
            if (category === 'content') return pfContent;
            if (category === 'template') return pfTemplate;
            return pfStyle;
        }

        function renderFileList(category) {
            const arr = getFileArray(category);
            const listId = category === 'content' ? 'pfContentList' : category === 'template' ? 'pfTemplateList' : 'pfStyleList';
            const el = document.getElementById(listId);
            if (arr.length === 0) { el.innerHTML = ''; return; }
            el.innerHTML = arr.map((f, i) => `
                <div class="pf-file-item">
                    <span>${f.isDefault ? 'ðŸ“Œ ' : ''}${f.name}</span>
                    <button class="pf-file-remove" onclick="removeFile('${category}',${i})">&times;</button>
                </div>
            `).join('');
        }

        function removeFile(category, idx) {
            getFileArray(category).splice(idx, 1);
            renderFileList(category);
        }

        function pfFiles(event, category) {
            const files = event.target.files;
            if (!files) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const catPath = category === 'template' ? 'templates' : category;
                    getFileArray(category).push({
                        name: file.name,
                        path: `provisions/inputs/${catPath}/${file.name}`,
                        content: e.target.result,
                        isDefault: false
                    });
                    renderFileList(category);
                };
                reader.readAsText(file);
            });
            event.target.value = '';
        }

        function pfDrop(event, category) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (!files) return;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const catPath = category === 'template' ? 'templates' : category;
                    getFileArray(category).push({
                        name: file.name,
                        path: `provisions/inputs/${catPath}/${file.name}`,
                        content: e.target.result,
                        isDefault: false
                    });
                    renderFileList(category);
                };
                reader.readAsText(file);
            });
        }

        function pfDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function pfDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        // ---- Step 3: Review ----
        function buildReview() {
            const topic = document.getElementById('pfTopic').value.trim() || 'â€”';
            const audience = document.getElementById('pfAudience').value.trim() || 'â€”';
            const length = document.getElementById('pfLength').value.trim() || 'â€”';
            const cCount = pfContent.length;
            const tCount = pfTemplate.length;
            const sCount = pfStyle.length;

            document.getElementById('pfReviewContent').innerHTML = `
                <div class="pf-review-item"><span class="pf-review-label">Topic</span><span class="pf-review-value">${escapeHtml(topic)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Audience</span><span class="pf-review-value">${escapeHtml(audience)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Length</span><span class="pf-review-value">${escapeHtml(length)}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Content refs</span><span class="pf-review-value">${cCount} file${cCount !== 1 ? 's' : ''}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Templates</span><span class="pf-review-value">${tCount} file${tCount !== 1 ? 's' : ''}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Style guides</span><span class="pf-review-value">${sCount} file${sCount !== 1 ? 's' : ''}</span></div>
                <div class="pf-review-item"><span class="pf-review-label">Model</span><span class="pf-review-value">${escapeHtml(selectedModel)}</span></div>
            `;
        }

        // ---- Step 3 â†’ 4: Launch ----
        async function launchRun() {
            const topic = document.getElementById('pfTopic').value.trim();
            const audience = document.getElementById('pfAudience').value.trim();
            const length = document.getElementById('pfLength').value.trim();
            const userId = `gui_${Date.now()}`;
            const launchBtn = document.getElementById('pfLaunchBtn');

            launchBtn.disabled = true;
            launchBtn.textContent = 'Uploading files...';

            try {
                // Upload user files
                const uploadFile = (f, category) => {
                    return fetch(`${serverUrl}/api/userbenches/${userId}/files/${f.path}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'text/plain; charset=utf-8' },
                        body: f.content
                    });
                };

                const uploads = [];
                [...pfContent, ...pfTemplate, ...pfStyle].forEach(f => {
                    if (!f.isDefault && f.content) uploads.push(uploadFile(f));
                });
                await Promise.all(uploads);

                // Build refs
                const contentRefs = pfContent.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'content' }));
                const templateRefs = pfTemplate.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'html_template' }));
                const styleRefs = pfStyle.map(f => ({ name: f.name.replace(/\.[^.]+$/, ''), path: f.path, type: f.type || 'guide' }));
                const allStyleRefs = [...templateRefs, ...styleRefs];

                const payload = {
                    plan_id: currentPlanId,
                    llm_model: selectedModel,
                    user_id: userId,
                    ground_inputs: {
                        '{æ¼”ç¤ºä¸»é¢˜}': { data: [[topic]], axes: ['_none_axis'] },
                        '{ç›®æ ‡å—ä¼—}': { data: [[audience || 'ä¸€èˆ¬å—ä¼—']], axes: ['_none_axis'] },
                        '{æœŸæœ›é•¿åº¦}': { data: [[length || '6å¼ å¹»ç¯ç‰‡']], axes: ['_none_axis'] },
                    }
                };
                if (contentRefs.length > 0) payload.ground_inputs['[å†…å®¹å‚è€ƒå…ƒæ•°æ®]'] = { data: [contentRefs], axes: ['å†…å®¹å‚è€ƒ'] };
                if (allStyleRefs.length > 0) payload.ground_inputs['[æ ·å¼å‚è€ƒå…ƒæ•°æ®]'] = { data: [allStyleRefs], axes: ['æ ·å¼å‚è€ƒ'] };

                launchBtn.textContent = 'Starting run...';

                const resp = await fetch(`${serverUrl}/api/runs`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Launch failed');
                }

                const data = await resp.json();
                const runId = data.run_id;

                // Move to step 4
                goTo(4);
                document.getElementById('pfRunStatus').textContent = `Run started: ${runId.substring(0, 8)}...`;
                document.getElementById('pfProgressFill').style.width = '10%';

                // Start SSE stream (placeholder â€” just update status)
                const evtSource = new EventSource(`${serverUrl}/api/runs/${runId}/stream`);
                evtSource.addEventListener('run:completed', () => {
                    document.getElementById('pfProgressFill').style.width = '100%';
                    document.getElementById('pfRunStatus').textContent = 'Completed!';
                    document.getElementById('pfRunSub').textContent = 'Generation finished successfully.';
                    evtSource.close();
                });
                evtSource.addEventListener('run:failed', (e) => {
                    document.getElementById('pfRunStatus').textContent = 'Failed: ' + (JSON.parse(e.data || '{}').error || 'Unknown error');
                    document.getElementById('pfProgressFill').style.width = '0%';
                    evtSource.close();
                });
                evtSource.addEventListener('execution:progress', (e) => {
                    try {
                        const d = JSON.parse(e.data);
                        if (d.completed != null && d.total) {
                            const pct = Math.round((d.completed / d.total) * 100);
                            document.getElementById('pfProgressFill').style.width = pct + '%';
                            document.getElementById('pfRunStatus').textContent = `${d.completed} / ${d.total} inferences`;
                        }
                    } catch (err) {}
                });
                evtSource.onerror = () => { evtSource.close(); };

            } catch (e) {
                alert('Launch failed: ' + e.message);
                launchBtn.disabled = false;
                launchBtn.textContent = 'Launch';
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ---- Init ----
        goTo(0);
        connectToServer();
    </script>
</body>
</html>
