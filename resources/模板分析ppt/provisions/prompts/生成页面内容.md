# 生成页面内容

## 任务目标
根据大纲规划和页面分析，为指定幻灯片生成具体的文本内容。

## 输入

### 1. 当前大纲页面 `{当前大纲页面}`
<outline_page>
$input_1
</outline_page>

包含这一页需要填充的内容规划，例如：

```json
{
  "slide_index": 1,
  "template_page": 3,
  "page_type": "content",
  "topic": "人工智能的核心技术",
  "content_plan": {
    "page_title": "AI核心技术栈",
    "blocks": [
      {"block": 1, "title": "机器学习", "description": "通过数据训练模型"},
      {"block": 2, "title": "深度学习", "description": "神经网络的多层结构"},
      {"block": 3, "title": "自然语言处理", "description": "理解和生成人类语言"}
    ]
  }
}
```

### 2. 此页分析 `{此页分析}`
<page_analysis>
$input_2
</page_analysis>

包含这一页的可替换元素信息，例如：

```json
{
  "index": 3,
  "page_intent": "三栏内容页",
  "narrative_structure": "并列关系",
  "substitutable_elements": [
    {
      "shape_index": 10,
      "role": "页面标题",
      "intent": "概括页面主题",
      "content_type": "标题",
      "constraints": {"max_chars": 20},
      "current_text": "CASE TITLE"
    },
    {
      "shape_index": 17,
      "role": "Block1标题",
      "intent": "第一要点的核心表述",
      "belongs_to_block": 1,
      "content_type": "关键词",
      "constraints": {"max_chars": 10},
      "current_text": "Point One"
    },
    {
      "shape_index": 21,
      "role": "Block1说明",
      "intent": "第一要点的详细解释",
      "belongs_to_block": 1,
      "content_type": "1-2句话",
      "constraints": {"max_chars": 80},
      "current_text": "Description here"
    }
  ],
  "fixed_elements": [
    {"shape_index": 1, "type": "text", "text": "01", "reason": "编号装饰"},
    {"shape_index": 0, "type": "picture", "reason": "背景图片"}
  ],
  "usage_notes": "适合展示3个并列概念"
}
```

## 输出格式

返回带有 `thinking` 和 `result` 字段的 JSON：

```json
{
  "thinking": "1. 从页面分析提取有效shape_index: [10, 17, 18, 19, 21, 22, 23]\n2. 计算每个元素的目标长度（原文字符数÷2）:\n- shape_index 10: 'CASE TITLE'=10字符 → 目标5中文字\n- shape_index 17: 'Point One'=9字符 → 目标4-5中文字\n- shape_index 21: 'Description here'=16字符 → 目标8中文字\n- shape_index 18/22, 19/23 同理...\n3. 核对：所有shape_index都在有效列表中 ✓\n4. 长度检查：每个生成文本≈目标长度 ✓",
  "result": {
    "slide_index": 1,
    "replacements": [
      {"shape_index": 10, "text": "AI核心技术"},
      {"shape_index": 17, "text": "机器学习"},
      {"shape_index": 21, "text": "数据驱动的模型训练"},
      {"shape_index": 18, "text": "深度学习"},
      {"shape_index": 22, "text": "多层神经网络结构"},
      {"shape_index": 19, "text": "自然语言"},
      {"shape_index": 23, "text": "人机语言交互理解"}
    ]
  }
}
```

**注意**：上例中的 shape_index (10, 17, 21, 18, 22, 19, 23) 全部来自页面分析的 `substitutable_elements`，不是凭空编造的！

## 生成规则

### ⚠️ 0. shape_index 必须精确匹配（最重要！）

**这是最常见的错误来源，请务必遵守：**

- 每个 replacement 的 `shape_index` 必须**直接从 `substitutable_elements` 复制**
- **禁止**推算、猜测或按规律递增 shape_index
- 如果页面分析显示 Block1说明 的 shape_index 是 21，就必须用 21，不能用 22

**正确做法示例：**
```
页面分析中: {"shape_index": 21, "role": "Block1说明", "belongs_to_block": 1}
输出时用:   {"shape_index": 21, "text": "..."}  ✅ 直接复制21
错误示例:   {"shape_index": 22, "text": "..."}  ❌ 不能随意改变
```

### 1. 只填充可替换元素
- 仅为 `substitutable_elements` 中的 `shape_index` 生成内容
- **不要**尝试修改 `fixed_elements`（如编号 01/02/03、背景图片）

### 2. 遵守约束条件
- 严格遵守 `constraints.max_chars` 字符限制
- 如果内容超长，需要精简表达

### 3. ⭐ 匹配原文本长度（最重要！）
- 每个 `substitutable_element` 都有 `current_text` 字段，表示模板中的原始占位文本
- **生成的文本长度必须接近 `current_text` 的长度** — 不能太长也不能太短！
- 文本框的大小是根据原文设计的，长度差异太大会导致布局问题

**中英文换算规则：**
- 1个中文字 ≈ 2个英文字符的显示宽度
- 计算目标：`目标中文字数 = current_text字符数 ÷ 2`

**短文本示例：**
```
原文本: "Point One" (9字符) → 目标约4-5中文字
✅ 好: "机器学习" (4字)
✅ 好: "深度学习" (4字)
❌ 差: "基于神经网络的多层结构" (太长)
❌ 差: "AI" (太短)
```

**长文本示例（关键！）：**
```
原文本: 650字符的英文段落 → 目标约300-350中文字！
❌ 错误: 只写70字的简短句子 (太短，文本框会大量留白)
✅ 正确: 写一段300字左右的完整论述，填满文本框
```

**长文本处理原则：**
- 如果 `current_text` 很长（超过100字符），说明这是一个**大段落文本框**
- 必须生成**同样丰富**的内容，不能只写一两句话
- 可以展开论述、举例说明、多角度阐述
- 目标是让新内容在视觉上与原模板占位符相当

### 4. 匹配内容结构
- 根据 `belongs_to_block` 将 content_plan 中的 blocks 映射到对应元素
- Block 1 的 title → 找到 `belongs_to_block: 1` 且 role 包含"标题"的元素，使用其 shape_index
- Block 1 的 description → 找到 `belongs_to_block: 1` 且 role 包含"说明"的元素，使用其 shape_index

### 5. 内容风格
- **标题类**：简洁有力，一目了然
- **说明类**：清晰完整，但不啰嗦
- **要点类**：提炼核心，便于记忆

### 6. 保持一致性
- 同一页面的多个 block 应保持风格统一
- 并列内容的字数应大致相当
- 遵循页面的 `narrative_structure`（并列/递进/主从）

## 特殊情况处理

### 标题页
```json
// content_plan
{"title": "演示主标题", "subtitle": "副标题内容"}

// 输出
{
  "slide_index": 0,
  "replacements": [
    {"shape_index": 10, "text": "演示主标题"},
    {"shape_index": 9, "text": "副标题内容"}
  ]
}
```

### 总结页
```json
// content_plan
{"summary_title": "总结", "takeaways": ["要点1", "要点2", "要点3"]}

// 需要根据 substitutable_elements 的数量和角色来分配
```

### 内容不足时
- 如果 content_plan 的 blocks 少于页面的 block 数量
- 可以扩展内容或留空（生成占位文本）
- 标注 `"note": "内容扩展"` 或 `"note": "需要补充"`

## 质量检查

生成前**必须**在 thinking 中完成以下验证：

### 第一步：列出所有有效的 shape_index
从 `substitutable_elements` 提取所有 shape_index，例如：
> "页面分析中的有效 shape_index: [17, 18, 19, 20, 21, 22, 23]"

### 第二步：逐一映射并计算目标长度
为每个 substitutable_element 确定对应内容，**计算目标中文字数 = 原文字符数 ÷ 2**：
> "shape_index 17 (页面标题, current_text='CASE TITLE' 10字符) → 目标5中文字"
> "shape_index 18 (Block1标题, current_text='Point One' 9字符) → 目标4-5中文字"
> "shape_index 9 (块说明, current_text=650字符的长段落) → ⚠️ 这是大段落！目标约300中文字，必须展开论述"
> ...

### 第三步：最终核对
确认每个 replacement 的 shape_index 都在第一步的列表中：
1. ✅ shape_index 17 存在于页面分析
2. ✅ shape_index 18 存在于页面分析
3. ✅ shape_index 21 存在于页面分析
4. ...

**如果发现某个 shape_index 不在列表中，必须修正！**

### 检查清单
- ✅ 所有 replacement 的 shape_index 都来自 substitutable_elements
- ✅ 没有遗漏任何可填充位置
- ✅ 所有文本都在字符限制内
- ✅ **生成文本长度 ≈ current_text长度÷2**（不能太长也不能太短！）
- ✅ **长段落（原文>100字符）必须生成同样丰富的内容**
- ✅ block 对应关系正确
- ✅ 风格与页面类型匹配

**重要：** 你的响应必须是有效的JSON，且必须包含这两个顶级键（thinking 和 result）。
