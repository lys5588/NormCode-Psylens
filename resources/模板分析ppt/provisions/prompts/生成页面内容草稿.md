# 生成页面内容草稿

## 任务目标
根据大纲规划和简化页面分析，为指定幻灯片生成具体的文本内容草稿。

## 输入

### 1. 当前大纲页面 `{当前大纲页面}`
<outline_page>
$input_1
</outline_page>

包含这一页需要填充的内容规划，例如：

```json
{
  "slide_index": 1,
  "template_page": 3,
  "page_type": "content",
  "topic": "人工智能的核心技术",
  "content_plan": {
    "page_title": "AI核心技术栈",
    "blocks": [
      {"block": 1, "title": "机器学习", "description": "通过数据训练模型"},
      {"block": 2, "title": "深度学习", "description": "神经网络的多层结构"},
      {"block": 3, "title": "自然语言处理", "description": "理解和生成人类语言"}
    ]
  }
}
```

### 2. 简化页面分析 `{分析简化版本}`
<simplified_analysis>
$input_2
</simplified_analysis>

包含这一页的可填充位置（已简化为 slot 编号），例如：

```json
{
  "page_intent": "三栏内容页",
  "narrative_structure": "并列关系",
  "slots": [
    {
      "slot": 1,
      "role": "页面标题",
      "intent": "概括页面主题",
      "content_type": "标题",
      "max_chars": 20,
      "current_text": "CASE TITLE"
    },
    {
      "slot": 2,
      "role": "Block1标题",
      "intent": "第一要点的核心表述",
      "belongs_to_block": 1,
      "content_type": "关键词",
      "max_chars": 10,
      "current_text": "Point One"
    },
    {
      "slot": 3,
      "role": "Block1说明",
      "intent": "第一要点的详细解释",
      "belongs_to_block": 1,
      "content_type": "1-2句话",
      "max_chars": 80,
      "current_text": "Description here"
    }
  ],
  "usage_notes": "适合展示3个并列概念",
  "total_slots": 3
}
```

**⚠️ 关键约束**：
- 输入使用简化的 `slot` 编号（1, 2, 3...），不是 shape_index
- **你只能为 `slots` 列表中存在的 slot 生成内容！**
- 如果 `slots` 列表有 3 个元素（slot 1, 2, 3），你只能输出这 3 个 slot
- **严禁生成不存在的 slot！** 例如：如果输入只有 slot 1-3，不能输出 slot 4, 5, 6...

## 输出格式

返回带有 `thinking` 和 `result` 字段的 JSON：

```json
{
  "thinking": "1. 从简化分析提取有效 slot: [1, 2, 3]（共3个）\n2. 计算每个元素的目标长度（原文字符数÷2）:\n- slot 1: 'CASE TITLE'=10字符 → 目标5中文字\n- slot 2: 'Point One'=9字符 → 目标4-5中文字\n- slot 3: 'Description here'=16字符 → 目标8中文字\n3. 长度检查：每个生成文本≈目标长度 ✓\n4. 确认：只输出3个slot，与输入一致 ✓",
  "result": {
    "slide_index": 1,
    "replacements": [
      {"slot": 1, "text": "AI核心技术", "target_length": 5},
      {"slot": 2, "text": "机器学习", "target_length": 5},
      {"slot": 3, "text": "数据驱动的模型训练", "target_length": 8}
    ]
  }
}
```

**⚠️ 注意上面的示例：输入只有 3 个 slot，所以输出也只有 3 个 replacement！**

**输出字段说明**：
- `slot`: 位置编号（1, 2, 3...），直接从 `slots` 列表复制
- `text`: 生成的草稿文本
- `target_length`: 目标中文字数（= current_text字符数 ÷ 2），供后续充实步骤参考

## 生成规则

### 1. ⭐ 内容必须符合大纲（最重要！）

**生成的内容必须严格来自 `{当前大纲页面}` 的 `content_plan`！**

- ✅ **从大纲提取内容**：`content_plan` 中的 `title`、`blocks`、`description` 等是你的内容来源
- ✅ **忠实于大纲**：不要编造大纲中没有的内容
- ✅ **完整覆盖**：大纲中的每个要点都应该体现在对应的 slot 中
- ❌ **禁止偏离**：不要用自己的知识替换或"改进"大纲内容

**示例**：
```
大纲 content_plan:
  - block 1: {title: "上下文隔离", description: "每步只访问显式传入数据"}
  - block 2: {title: "完整审计", description: "所有推理步骤自动记录"}

正确输出：
  - slot 对应 block1 标题: "上下文隔离"（直接用大纲的）
  - slot 对应 block1 说明: "每步只访问显式传入数据"（直接用大纲的）

错误输出：
  - slot 对应 block1 标题: "数据安全"（❌ 大纲写的是"上下文隔离"！）
  - slot 对应 block1 说明: "使用加密技术保护数据"（❌ 编造的，大纲没这个！）
```

### 2. 使用 slot 编号（简单！）

- 每个 replacement 使用 `slot` 编号（1, 2, 3...）
- 直接从输入的 `slots` 列表复制 slot 编号
- **不需要关心底层的 shape_index**（系统会自动处理）

**示例**：
```
输入 slots: [{"slot": 1, "role": "页面标题"}, {"slot": 2, "role": "副标题"}]
输出: [{"slot": 1, "text": "..."}, {"slot": 2, "text": "..."}]
```

### 4. 遵守约束条件
- 严格遵守 `max_chars` 字符限制
- 如果内容超长，需要精简表达

### 5. 匹配原文本长度
- 每个 slot 都有 `current_text` 字段，表示模板中的原始占位文本
- **生成的文本长度必须接近 `current_text` 的长度** — 不能太长也不能太短！
- 文本框的大小是根据原文设计的，长度差异太大会导致布局问题

**中英文换算规则：**
- 1个中文字 ≈ 2个英文字符的显示宽度
- 计算目标：`目标中文字数 = current_text字符数 ÷ 2`

**短文本示例：**
```
原文本: "Point One" (9字符) → 目标约4-5中文字
✅ 好: "机器学习" (4字)
✅ 好: "深度学习" (4字)
❌ 差: "基于神经网络的多层结构" (太长)
❌ 差: "AI" (太短)
```

**长文本示例（关键！）：**
```
原文本: 650字符的英文段落 → 目标约300-350中文字！
❌ 错误: 只写70字的简短句子 (太短，文本框会大量留白)
✅ 正确: 写一段300字左右的完整论述，填满文本框
```

### 6. 匹配内容结构
- 根据 `belongs_to_block` 将 content_plan 中的 blocks 映射到对应 slot
- Block 1 的 title → 找到 `belongs_to_block: 1` 且 role 包含"标题"的 slot
- Block 1 的 description → 找到 `belongs_to_block: 1` 且 role 包含"说明"的 slot

### 7. 内容风格
- **标题类**：简洁有力，一目了然
- **说明类**：清晰完整，但不啰嗦
- **要点类**：提炼核心，便于记忆

### 8. 保持一致性
- 同一页面的多个 block 应保持风格统一
- 并列内容的字数应大致相当
- 遵循页面的 `narrative_structure`（并列/递进/主从）

## 特殊情况处理

### 标题页
```json
// content_plan
{"title": "演示主标题", "subtitle": "副标题内容"}

// 输出
{
  "slide_index": 0,
  "replacements": [
    {"slot": 1, "text": "演示主标题", "target_length": 6},
    {"slot": 2, "text": "副标题内容", "target_length": 10}
  ]
}
```

### 总结页
```json
// content_plan
{"summary_title": "总结", "takeaways": ["要点1", "要点2", "要点3"]}

// 需要根据 slots 的数量和角色来分配
```

### 内容不足时
- 如果 content_plan 的 blocks 少于页面的 slot 数量
- 可以扩展内容或留空（生成占位文本）
- 标注 `"note": "内容扩展"` 或 `"note": "需要补充"`

## 质量检查

生成前**必须**在 thinking 中完成以下验证：

### 第一步：提取大纲内容（⭐ 最重要！）
从 `content_plan` 中列出所有要填充的内容：
> "大纲内容：
> - page_title: 'NormCode核心特性'
> - block 1: title='上下文隔离', description='每步只访问显式传入数据'
> - block 2: title='完整审计', description='所有推理步骤自动记录'
> - block 3: title='可复现性', description='相同输入产生确定性输出'"

**这些就是你要填入 slot 的内容来源！**

### 第二步：列出所有有效的 slot
从 `slots` 列表提取所有 slot 编号，**数一数有几个**：
> "页面分析中的有效 slot: [1, 2, 3]，共 3 个"

**你只能输出这些 slot！不能凭空创造新的 slot！**

### 第三步：映射大纲内容到 slot
将大纲内容映射到对应的 slot，同时计算目标长度：
> "slot 1 (页面标题) ← 大纲 page_title='NormCode核心特性', current_text=10字符 → 目标5中文字"
> "slot 2 (Block1标题) ← 大纲 block1.title='上下文隔离', current_text=9字符 → 目标4-5中文字"
> "slot 3 (Block1说明) ← 大纲 block1.description='每步只访问显式传入数据', current_text=16字符 → 目标8中文字"

**确保每个 slot 的内容都来自大纲！**

### 第四步：最终核对
确认每个 replacement 的 slot 都在第一步的列表中：
1. ✅ slot 1 存在于 slots 列表
2. ✅ slot 2 存在于 slots 列表
3. ✅ slot 3 存在于 slots 列表
4. ...

### 检查清单
- ✅ **所有内容都来自大纲 content_plan**（最重要！不能编造）
- ✅ **replacement 数量 = slots 列表长度**（不能多也不能少）
- ✅ 所有 replacement 的 slot 都来自 slots 列表（不能凭空创造）
- ✅ 没有遗漏任何可填充位置
- ✅ 所有文本都在字符限制内
- ✅ **生成文本长度 ≈ current_text长度÷2**（不能太长也不能太短！）
- ✅ **长段落（原文>100字符）必须生成同样丰富的内容**
- ✅ block 对应关系正确
- ✅ 风格与页面类型匹配

**❌ 常见错误：**
1. 输入只有 3 个 slot，却输出 7 个 replacement — 严重错误！
2. 大纲写的是"上下文隔离"，却输出"数据安全" — 内容偏离大纲！

**重要：** 你的响应必须是有效的JSON，且必须包含这两个顶级键（thinking 和 result）。
